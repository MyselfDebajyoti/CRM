{% extends 'hrm/base.html' %}

{% block content %}
<div class="container">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3><i class="fas fa-plus-circle"></i> Add Expense</h3>
          <span class="badge bg-info">Quick & Easy</span>
        </div>
        <div class="card-body">
          <form method="post" id="expenseForm">
            {% csrf_token %}
            
            <!-- Expense Type with enhanced features -->
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="{{ form.expense_type.id_for_label }}" class="form-label">
                    <i class="fas fa-tags"></i> Expense Type
                  </label>
                  <select name="{{ form.expense_type.name }}" id="{{ form.expense_type.id_for_label }}" class="form-select" required>
                    <option value="">Select expense type...</option>
                    <option value="TRAVEL" data-icon="fas fa-car" data-color="primary">üöó Travel</option>
                    <option value="FOOD" data-icon="fas fa-utensils" data-color="success">üçΩÔ∏è Food & Meals</option>
                    <option value="ACCOMMODATION" data-icon="fas fa-bed" data-color="warning">üè® Accommodation</option>
                    <option value="FUEL" data-icon="fas fa-gas-pump" data-color="info">‚õΩ Fuel</option>
                    <option value="COMMUNICATION" data-icon="fas fa-phone" data-color="secondary">üì± Communication</option>
                    <option value="OFFICE_SUPPLIES" data-icon="fas fa-paperclip" data-color="dark">üìé Office Supplies</option>
                    <option value="TRAINING" data-icon="fas fa-graduation-cap" data-color="danger">üéì Training</option>
                    <option value="OTHER" data-icon="fas fa-ellipsis-h" data-color="light">üìã Other</option>
                  </select>
                  <div class="form-text">Choose the category that best describes your expense</div>
                </div>
                
                <!-- Type-specific tips -->
                <div id="typeTips" class="alert alert-light d-none">
                  <small><i class="fas fa-lightbulb"></i> <span id="tipText"></span></small>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="{{ form.expense_date.id_for_label }}" class="form-label">
                    <i class="fas fa-calendar"></i> Expense Date
                  </label>
                  {{ form.expense_date }}
                  <div class="form-text">When did this expense occur?</div>
                </div>
              </div>
            </div>

            <!-- Description with smart suggestions -->
            <div class="mb-3">
              <label for="{{ form.description.id_for_label }}" class="form-label">
                <i class="fas fa-edit"></i> Description
              </label>
              {{ form.description }}
              <div class="form-text">Provide details about this expense</div>
              
              <!-- Smart suggestions based on type -->
              <div id="suggestions" class="mt-2 d-none">
                <small class="text-muted">üí° Quick suggestions: </small>
                <div id="suggestionTags"></div>
              </div>
            </div>

            <!-- Amount with currency formatting -->
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="{{ form.amount.id_for_label }}" class="form-label">
                    <i class="fas fa-rupee-sign"></i> Amount (‚Çπ)
                  </label>
                  <div class="input-group">
                    <span class="input-group-text">‚Çπ</span>
                    {{ form.amount }}
                  </div>
                  <div class="form-text">Enter the total amount spent</div>
                  <div id="amountFeedback" class="mt-1"></div>
                </div>
              </div>
              
              <div class="col-md-6">
                <!-- Amount validation feedback -->
                <div class="mt-4 pt-2">
                  <div id="amountRange" class="small text-muted d-none">
                    <i class="fas fa-info-circle"></i> 
                    <span id="rangeText"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Enhanced Receipt upload with cloud storage -->
            <div class="mb-3">
              <label for="receiptInput" class="form-label">
                <i class="fas fa-receipt"></i> Receipt
              </label>
              
              <!-- File input with drag and drop -->
              <div class="receipt-upload-area" id="receiptUploadArea">
                <div class="upload-content">
                  <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                  <p class="text-muted">Drag & drop your receipt here or <strong>click to browse</strong></p>
                  <small class="text-muted">Supports JPG, PNG, PDF (Max 5MB)</small>
                  <input type="file" id="receiptInput" name="receipt" accept=".jpg,.jpeg,.png,.pdf" class="d-none">
                </div>
                
                <!-- Upload progress -->
                <div id="uploadProgress" class="upload-progress d-none">
                  <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                  </div>
                  <small class="text-muted">Uploading receipt...</small>
                </div>
              </div>
              
              <!-- Upload status -->
              <div id="uploadStatus" class="mt-2"></div>
              
              <!-- Receipt preview -->
              <div id="receiptPreview" class="mt-3 d-none">
                <div class="card bg-light">
                  <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h6 class="card-title mb-1">Receipt Uploaded:</h6>
                        <small id="receiptFilename" class="text-muted"></small>
                      </div>
                      <button type="button" class="btn btn-sm btn-outline-danger" id="removeReceiptBtn">
                        <i class="fas fa-times"></i> Remove
                      </button>
                    </div>
                    <div id="previewContent" class="mt-2"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Hidden fields for receipt data -->
            <input type="hidden" id="receiptPublicId" name="receipt_public_id">
            <input type="hidden" id="receiptUrl" name="receipt_url">
            <input type="hidden" id="receiptFileName" name="receipt_filename">

            <!-- Form summary before submit -->
            <div id="formSummary" class="card bg-light d-none mb-3">
              <div class="card-body p-3">
                <h6 class="card-title"><i class="fas fa-clipboard-check"></i> Expense Summary</h6>
                <div class="row">
                  <div class="col-md-6">
                    <small><strong>Type:</strong> <span id="summaryType">-</span></small><br>
                    <small><strong>Date:</strong> <span id="summaryDate">-</span></small>
                  </div>
                  <div class="col-md-6">
                    <small><strong>Amount:</strong> ‚Çπ<span id="summaryAmount">0</span></small><br>
                    <small><strong>Receipt:</strong> <span id="summaryReceipt">Not uploaded</span></small>
                  </div>
                </div>
              </div>
            </div>

            <div class="d-flex justify-content-between align-items-center">
              <div>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                  <i class="fas fa-plus"></i> Add Expense
                </button>
                <a href="{% url 'reimbursement_claims' %}" class="btn btn-outline-secondary">
                  <i class="fas fa-times"></i> Cancel
                </a>
              </div>
              
              <div class="text-muted small">
                <i class="fas fa-shield-alt"></i> All data is secure and encrypted
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.suggestion-tag {
  display: inline-block;
  background: #e9ecef;
  border: 1px solid #dee2e6;
  border-radius: 15px;
  padding: 2px 8px;
  margin: 2px;
  font-size: 0.8em;
  cursor: pointer;
  transition: all 0.2s;
}

.suggestion-tag:hover {
  background: #007bff;
  color: white;
  transform: translateY(-1px);
}

.form-select:focus, .form-control:focus {
  border-color: #86b7fe;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.input-group .form-control {
  border-left: none;
}

/* Receipt upload area styling */
.receipt-upload-area {
  border: 2px dashed #dee2e6;
  border-radius: 8px;
  padding: 30px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  background: #f8f9fa;
}

.receipt-upload-area:hover {
  border-color: #007bff;
  background: #f0f4ff;
}

.receipt-upload-area.dragover {
  border-color: #007bff;
  background: #e7f1ff;
  transform: scale(1.02);
}

.receipt-upload-area.uploading {
  border-color: #28a745;
  background: #f0fff4;
}

.upload-progress {
  padding: 20px;
}

.progress {
  height: 8px;
  margin-bottom: 10px;
}

#receiptPreview img {
  max-width: 100%;
  max-height: 200px;
  border-radius: 5px;
  border: 1px solid #dee2e6;
}

.amount-warning {
  color: #856404;
  background-color: #fff3cd;
  border: 1px solid #ffecb5;
  border-radius: 0.25rem;
  padding: 0.25rem 0.5rem;
  margin-top: 0.25rem;
  font-size: 0.875em;
}

.amount-error {
  color: #721c24;
  background-color: #f8d7da;
  border: 1px solid #f5c6cb;
  border-radius: 0.25rem;
  padding: 0.25rem 0.5rem;
  margin-top: 0.25rem;
  font-size: 0.875em;
}

.upload-success {
  color: #155724;
  background-color: #d4edda;
  border: 1px solid #c3e6cb;
  border-radius: 0.25rem;
  padding: 0.5rem;
  margin-top: 0.5rem;
}

.upload-error {
  color: #721c24;
  background-color: #f8d7da;
  border: 1px solid #f5c6cb;
  border-radius: 0.25rem;
  padding: 0.5rem;
  margin-top: 0.5rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const expenseTypeSelect = document.getElementById('{{ form.expense_type.id_for_label }}');
    const descriptionInput = document.getElementById('{{ form.description.id_for_label }}');
    const amountInput = document.getElementById('{{ form.amount.id_for_label }}');
    const receiptInput = document.getElementById('receiptInput');
    const dateInput = document.getElementById('{{ form.expense_date.id_for_label }}');
    const uploadArea = document.getElementById('receiptUploadArea');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadStatus = document.getElementById('uploadStatus');

    // Receipt upload data
    let uploadedReceipt = null;

    // Type-specific data
    const typeData = {
        'TRAVEL': {
            tips: 'Include origin and destination. Keep all receipts for taxi, train, or flight tickets.',
            suggestions: ['Taxi fare', 'Train ticket', 'Flight ticket', 'Bus fare', 'Auto rickshaw', 'Parking fee'],
            ranges: { min: 50, max: 10000, typical: 500 }
        },
        'FOOD': {
            tips: 'Include business meals with clients or during travel. Personal meals are not reimbursable.',
            suggestions: ['Client lunch', 'Business dinner', 'Travel meal', 'Conference catering', 'Team lunch'],
            ranges: { min: 100, max: 2000, typical: 300 }
        },
        'ACCOMMODATION': {
            tips: 'Hotel stays for business travel. Include check-in and check-out dates.',
            suggestions: ['Hotel room', 'Guest house', 'Service apartment', 'Lodge stay'],
            ranges: { min: 1000, max: 15000, typical: 3000 }
        },
        'FUEL': {
            tips: 'Fuel expenses for company vehicle or personal vehicle used for business.',
            suggestions: ['Petrol', 'Diesel', 'CNG', 'Vehicle fuel'],
            ranges: { min: 200, max: 5000, typical: 1000 }
        },
        'COMMUNICATION': {
            tips: 'Business-related phone bills, internet charges, or mobile recharge.',
            suggestions: ['Mobile recharge', 'Internet bill', 'Phone bill', 'Data charges'],
            ranges: { min: 100, max: 2000, typical: 400 }
        },
        'OFFICE_SUPPLIES': {
            tips: 'Stationery, office equipment, or supplies needed for work.',
            suggestions: ['Stationery', 'Printer ink', 'Office equipment', 'Computer accessories'],
            ranges: { min: 50, max: 5000, typical: 500 }
        },
        'TRAINING': {
            tips: 'Course fees, training materials, or certification expenses.',
            suggestions: ['Course fee', 'Training material', 'Certification exam', 'Workshop fee'],
            ranges: { min: 500, max: 25000, typical: 5000 }
        },
        'OTHER': {
            tips: 'Any other business-related expense not covered in above categories.',
            suggestions: ['Miscellaneous', 'Business expense', 'Other fee'],
            ranges: { min: 50, max: 10000, typical: 500 }
        }
    };

    // Handle expense type changes
    expenseTypeSelect.addEventListener('change', function() {
        const selectedType = this.value;
        const tipDiv = document.getElementById('typeTips');
        const suggestionsDiv = document.getElementById('suggestions');
        const tipText = document.getElementById('tipText');
        const suggestionTags = document.getElementById('suggestionTags');
        const amountRange = document.getElementById('amountRange');
        const rangeText = document.getElementById('rangeText');

        if (selectedType && typeData[selectedType]) {
            const data = typeData[selectedType];
            
            // Show tips
            tipText.textContent = data.tips;
            tipDiv.classList.remove('d-none');
            
            // Show suggestions
            suggestionTags.innerHTML = '';
            data.suggestions.forEach(suggestion => {
                const tag = document.createElement('span');
                tag.className = 'suggestion-tag';
                tag.textContent = suggestion;
                tag.onclick = () => {
                    descriptionInput.value = suggestion;
                    updateFormSummary();
                };
                suggestionTags.appendChild(tag);
            });
            suggestionsDiv.classList.add('d-none');
            amountRange.classList.add('d-none');
        }
        
        updateFormSummary();
    });

    // Handle amount validation
    amountInput.addEventListener('input', function() {
        const amount = parseFloat(this.value);
        const selectedType = expenseTypeSelect.value;
        const feedbackDiv = document.getElementById('amountFeedback');
        
        feedbackDiv.innerHTML = '';
        
        if (amount && selectedType && typeData[selectedType]) {
            const ranges = typeData[selectedType].ranges;
            
            if (amount < ranges.min) {
                feedbackDiv.innerHTML = `<div class="amount-warning"><i class="fas fa-exclamation-triangle"></i> Amount seems low for ${selectedType.toLowerCase()}. Please verify.</div>`;
            } else if (amount > ranges.max) {
                feedbackDiv.innerHTML = `<div class="amount-error"><i class="fas fa-exclamation-circle"></i> Amount exceeds typical range. Manager approval may be required.</div>`;
            } else if (amount > ranges.typical * 2) {
                feedbackDiv.innerHTML = `<div class="amount-warning"><i class="fas fa-info-circle"></i> Higher than typical amount. Please ensure receipt is attached.</div>`;
            }
        }
        
        updateFormSummary();
    });

    // Enhanced receipt upload handling
    uploadArea.addEventListener('click', function() {
        receiptInput.click();
    });

    // Drag and drop functionality
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileUpload(files[0]);
        }
    });

    receiptInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            handleFileUpload(this.files[0]);
        }
    });

    function handleFileUpload(file) {
        // Validate file
        if (!validateFile(file)) {
            return;
        }

        // Show upload progress
        showUploadProgress();
        
        // Create FormData
        const formData = new FormData();
        formData.append('receipt', file);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        // Upload file
        fetch('{% url "upload_receipt_ajax" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            hideUploadProgress();
            
            if (data.success) {
                uploadedReceipt = data;
                showUploadSuccess(data);
                updateFormSummary();
                
                // Store receipt data in hidden fields
                document.getElementById('receiptPublicId').value = data.public_id;
                document.getElementById('receiptUrl').value = data.secure_url;
                document.getElementById('receiptFileName').value = data.filename;
            } else {
                showUploadError(data.error);
            }
        })
        .catch(error => {
            hideUploadProgress();
            showUploadError('Upload failed. Please try again.');
            console.error('Upload error:', error);
        });
    }

    function validateFile(file) {
        // Check file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
            showUploadError('File size must be less than 5MB');
            return false;
        }

        // Check file type
        const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];
        if (!allowedTypes.includes(file.type)) {
            showUploadError('Only JPG, PNG, and PDF files are allowed');
            return false;
        }

        return true;
    }

    function showUploadProgress() {
        uploadArea.classList.add('uploading');
        uploadProgress.classList.remove('d-none');
        uploadStatus.innerHTML = '';
        
        // Animate progress bar
        const progressBar = uploadProgress.querySelector('.progress-bar');
        let width = 0;
        const interval = setInterval(() => {
            width += 5;
            progressBar.style.width = width + '%';
            if (width >= 90) {
                clearInterval(interval);
            }
        }, 100);
    }

    function hideUploadProgress() {
        uploadArea.classList.remove('uploading');
        uploadProgress.classList.add('d-none');
        const progressBar = uploadProgress.querySelector('.progress-bar');
        progressBar.style.width = '0%';
    }

    function showUploadSuccess(data) {
        uploadStatus.innerHTML = `
            <div class="upload-success">
                <i class="fas fa-check-circle"></i> Receipt uploaded successfully
            </div>
        `;
        
        showReceiptPreview(data);
    }

    function showUploadError(message) {
        uploadStatus.innerHTML = `
            <div class="upload-error">
                <i class="fas fa-exclamation-circle"></i> ${message}
            </div>
        `;
    }

    function showReceiptPreview(data) {
        const previewDiv = document.getElementById('receiptPreview');
        const previewContent = document.getElementById('previewContent');
        const filenameSpan = document.getElementById('receiptFilename');
        
        filenameSpan.textContent = data.filename;
        
        // Show preview based on file type
        if (data.secure_url.includes('.pdf')) {
            previewContent.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-file-pdf fa-3x text-danger mb-2"></i>
                    <p class="small text-muted">PDF Receipt</p>
                    <a href="${data.secure_url}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-external-link-alt"></i> View PDF
                    </a>
                </div>
            `;
        } else {
            previewContent.innerHTML = `
                <div class="text-center">
                    <img src="${data.secure_url}" alt="Receipt preview" class="img-thumbnail">
                </div>
            `;
        }
        
        previewDiv.classList.remove('d-none');
    }

    // Remove receipt functionality
    document.getElementById('removeReceiptBtn').addEventListener('click', function() {
        uploadedReceipt = null;
        document.getElementById('receiptPreview').classList.add('d-none');
        document.getElementById('receiptPublicId').value = '';
        document.getElementById('receiptUrl').value = '';
        document.getElementById('receiptFileName').value = '';
        receiptInput.value = '';
        uploadStatus.innerHTML = '';
        updateFormSummary();
    });

    // Update form summary
    function updateFormSummary() {
        const summaryDiv = document.getElementById('formSummary');
        const summaryType = document.getElementById('summaryType');
        const summaryDate = document.getElementById('summaryDate');
        const summaryAmount = document.getElementById('summaryAmount');
        const summaryReceipt = document.getElementById('summaryReceipt');

        const hasData = expenseTypeSelect.value || amountInput.value || descriptionInput.value;
        
        if (hasData) {
            summaryType.textContent = expenseTypeSelect.options[expenseTypeSelect.selectedIndex].text || '-';
            summaryDate.textContent = dateInput.value || '-';
            summaryAmount.textContent = amountInput.value || '0';
            summaryReceipt.textContent = uploadedReceipt ? uploadedReceipt.filename : 'Not uploaded';
            summaryDiv.classList.remove('d-none');
        } else {
            summaryDiv.classList.add('d-none');
        }
    }

    // Add event listeners for summary updates
    [descriptionInput, dateInput].forEach(input => {
        input.addEventListener('input', updateFormSummary);
    });

    // Set default date to today
    if (!dateInput.value) {
        dateInput.valueAsDate = new Date();
    }

    // Form submission handling
    document.getElementById('expenseForm').addEventListener('submit', function(e) {
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding Expense...';
        submitBtn.disabled = true;
    });
});
</script>
{% endblock %}