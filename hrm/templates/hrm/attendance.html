{% extends 'hrm/base.html' %}

{% block title %}Attendance Tracking - HRM{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1>Attendance Tracking</h1>
            <p>Welcome, {{ employee.user.get_full_name }}!</p>
        </div>
    </div>

    <!-- Today's Attendance Status -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3>Today's Attendance - {{ current_month }} {{ current_year }}</h3>
                </div>
                <div class="card-body">
                    {% if today_attendance %}
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Login Details</h5>
                                <p><strong>Login Time:</strong> 
                                    {% if today_attendance.login_time %}
                                        {{ today_attendance.login_time|time:"H:i" }}
                                        {% if today_attendance.is_late %}
                                            <span class="badge badge-warning">Late</span>
                                        {% endif %}
                                    {% else %}
                                        Not logged in
                                    {% endif %}
                                </p>
                                <p><strong>Work Mode:</strong> 
                                    {% if today_attendance.is_remote %}
                                        <span class="badge badge-info">Remote</span>
                                    {% else %}
                                        <span class="badge badge-success">Office</span>
                                    {% endif %}
                                </p>
                                {% if today_attendance.notes %}
                                    <p><strong>Notes:</strong> {{ today_attendance.notes }}</p>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <h5>Logout Details</h5>
                                <p><strong>Logout Time:</strong> 
                                    {% if today_attendance.logout_time %}
                                        {{ today_attendance.logout_time|time:"H:i" }}
                                        {% if today_attendance.is_early_departure %}
                                            <span class="badge badge-warning">Early Departure</span>
                                        {% endif %}
                                    {% else %}
                                        Not logged out
                                    {% endif %}
                                </p>
                                {% if today_attendance.logout_time and today_attendance.login_time %}
                                    <p><strong>Total Hours:</strong> {{ today_attendance.total_hours|floatformat:2 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <p>No attendance record for today. Please log in to mark your attendance.</p>
                    {% endif %}

                    <!-- Attendance Actions -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h5>Actions</h5>
                            {% if not today_attendance %}
                                <button type="button" class="btn btn-success" onclick="markAttendance('login')">
                                    Clock In
                                </button>
                            {% elif today_attendance and not today_attendance.logout_time %}
                                <button type="button" class="btn btn-danger" onclick="markAttendance('logout')">
                                    Clock Out
                                </button>
                            {% else %}
                                <p class="text-muted">You have completed your attendance for today.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Summary -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h4>Monthly Summary</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <h6>Present Days</h6>
                            <h3>{{ present_days }}</h3>
                        </div>
                        <div class="col-6">
                            <h6>Total Days</h6>
                            <h3>{{ total_days }}</h3>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-6">
                            <h6>Remote Days</h6>
                            <h3>{{ remote_days }}</h3>
                        </div>
                        <div class="col-6">
                            <h6>Late Days</h6>
                            <h3>{{ late_days }}</h3>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <h6>Total Hours</h6>
                            <h3>{{ total_hours }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Attendance Records -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4>Monthly Attendance Records</h4>
                </div>
                <div class="card-body">
                    {% if monthly_attendance %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Login Time</th>
                                        <th>Logout Time</th>
                                        <th>Total Hours</th>
                                        <th>Work Mode</th>
                                        <th>Status</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for attendance in monthly_attendance %}
                                        <tr>
                                            <td>{{ attendance.date|date:"M d, Y" }}</td>
                                            <td>
                                                {% if attendance.login_time %}
                                                    {{ attendance.login_time|time:"H:i" }}
                                                    {% if attendance.is_late %}
                                                        <span class="badge badge-warning">Late</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if attendance.logout_time %}
                                                    {{ attendance.logout_time|time:"H:i" }}
                                                    {% if attendance.is_early_departure %}
                                                        <span class="badge badge-warning">Early</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if attendance.total_hours %}
                                                    {{ attendance.total_hours|floatformat:2 }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if attendance.is_remote %}
                                                    <span class="badge badge-info">Remote</span>
                                                {% else %}
                                                    <span class="badge badge-success">Office</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if attendance.login_time %}
                                                    <span class="badge badge-success">Present</span>
                                                {% else %}
                                                    <span class="badge badge-danger">Absent</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if attendance.notes %}
                                                    {{ attendance.notes|truncatewords:5 }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">No attendance records found for this month.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Links -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5>Quick Links</h5>
                    <a href="{% url 'hrm_dashboard' %}" class="btn btn-primary">Dashboard</a>
                    <a href="{% url 'leave_calendar' %}" class="btn btn-info">Leave Calendar</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden form for attendance actions -->
<form id="attendanceForm" method="post" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="action" id="attendanceAction">
    <input type="hidden" name="latitude" id="attendanceLatitude">
    <input type="hidden" name="longitude" id="attendanceLongitude">
</form>

<!-- JavaScript for Attendance Tracking -->
<script>
function markAttendance(action) {
    // Show loading state
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'Processing...';
    
    // Get user location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                submitAttendance(action, position.coords.latitude, position.coords.longitude);
            },
            function(error) {
                console.log('Location error:', error);
                // Submit without location
                submitAttendance(action, null, null);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    } else {
        // Submit without location if geolocation is not supported
        submitAttendance(action, null, null);
    }
    
    // Reset button state
    setTimeout(function() {
        button.disabled = false;
        button.textContent = originalText;
    }, 3000);
}

function submitAttendance(action, latitude, longitude) {
    // Set form values
    document.getElementById('attendanceAction').value = action;
    document.getElementById('attendanceLatitude').value = latitude || '';
    document.getElementById('attendanceLongitude').value = longitude || '';
    
    // Submit form
    document.getElementById('attendanceForm').submit();
}

// Auto-refresh page every 5 minutes to show updated data
setInterval(function() {
    if (document.visibilityState === 'visible') {
        location.reload();
    }
}, 300000); // 5 minutes

// Show current time
function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', { 
        hour12: false, 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
    });
    const dateString = now.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    // Update page title with current time
    document.title = `Attendance (${timeString}) - HRM`;
    
    // Add current time display if it doesn't exist
    let timeDisplay = document.getElementById('currentTimeDisplay');
    if (!timeDisplay) {
        timeDisplay = document.createElement('div');
        timeDisplay.id = 'currentTimeDisplay';
        timeDisplay.className = 'alert alert-info';
        timeDisplay.innerHTML = `<strong>Current Time:</strong> <span id="timeValue">${timeString}</span> | <strong>Date:</strong> ${dateString}`;
        
        const container = document.querySelector('.container-fluid .row:first-child');
        if (container) {
            container.appendChild(timeDisplay);
        }
    } else {
        document.getElementById('timeValue').textContent = timeString;
    }
}

// Update time every second
setInterval(updateCurrentTime, 1000);
updateCurrentTime(); // Initial call

// Location permission request
document.addEventListener('DOMContentLoaded', function() {
    // Request location permission on page load
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                console.log('Location permission granted');
            },
            function(error) {
                if (error.code === error.PERMISSION_DENIED) {
                    const locationWarning = document.createElement('div');
                    locationWarning.className = 'alert alert-warning alert-dismissible fade show';
                    locationWarning.innerHTML = `
                        <strong>Location Access:</strong> Please enable location access for accurate attendance tracking.
                        <button type="button" class="close" data-dismiss="alert">
                            <span>&times;</span>
                        </button>
                    `;
                    document.querySelector('.container-fluid').insertBefore(locationWarning, document.querySelector('.container-fluid').firstChild);
                }
            }
        );
    }
});

// Add confirmation for logout
function confirmLogout() {
    return confirm('Are you sure you want to clock out?');
}

// Modify the logout button to add confirmation
document.addEventListener('DOMContentLoaded', function() {
    const logoutButton = document.querySelector('button[onclick*="logout"]');
    if (logoutButton) {
        logoutButton.setAttribute('onclick', 'if(confirmLogout()) markAttendance("logout")');
    }
});
</script>
{% endblock %}