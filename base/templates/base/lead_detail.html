{% extends 'base/base.html' %}
{% load lead_extras %}

{% block title %}Lead Details: {{ lead.name }}{% endblock %}

{% block extra_css %}
<style>
    .verification-section {
        background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
        border-radius: 10px;
        border: 2px solid #e17055;
    }
    .verification-section .card-header {
        background: rgba(255, 255, 255, 0.2);
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }
    .client-preview-card {
        background: #f8f9fa;
        border: 2px dashed #6c757d;
        border-radius: 8px;
    }
    .timeline {
        position: relative;
        padding-left: 20px;
    }
    .timeline::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #dee2e6;
    }
    .timeline-item {
        position: relative;
        margin-bottom: 20px;
    }
    .timeline-item-marker {
        position: absolute;
        left: -15px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: white;
        border: 3px solid #6c757d;
    }
    .timeline-item-pending .timeline-item-marker {
        border-color: #ffc107;
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
    }
    .priority-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    .priority-high { background-color: #dc3545; }
    .priority-medium { background-color: #ffc107; }
    .priority-low { background-color: #28a745; }
    .conversion-flow-info {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-left: 4px solid #2196f3;
    }
    .ops-approval-pending {
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        border-left: 4px solid #ff9800;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>
                <i class="fas fa-user-circle text-primary"></i>
                Lead Details: {{ lead.name }}
                <span class="badge badge-{{ lead.status|lead_status_badge }} ml-2">
                    {{ lead.get_status_display }}
                </span>
            </h1>
            <p class="text-muted mb-0">
                Lead ID: {{ lead.lead_id }} | 
                Created: {{ lead.created_at|date:"M d, Y" }} |
                Assigned to: {{ lead.assigned_to.get_full_name }}
            </p>
        </div>
        <div>
            {% if user.can_access_user_data|user_can_edit:lead %}
            <a href="{% url 'lead_update' lead.pk %}" class="btn btn-secondary">
                <i class="fas fa-edit"></i> Edit Lead
            </a>
            {% endif %}
            <a href="{% url 'lead_list' %}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
            {% if user.role in 'ops_team_lead,ops_exec'|split %}
            <a href="{% url 'ops_pending_approvals' %}" class="btn btn-warning">
                <i class="fas fa-clipboard-check"></i> All Pending Approvals
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Priority Alert for Ops Team -->
    {% if user.role in 'ops_team_lead,ops_exec'|split and pending_approval %}
    <div class="alert alert-warning alert-dismissible fade show">
        <div class="d-flex align-items-center">
            <span class="priority-indicator priority-high"></span>
            <div>
                <strong><i class="fas fa-exclamation-triangle"></i> Action Required:</strong>
                This lead requires business verification for conversion approval.
                <small class="d-block">
                    Requested {{ pending_approval.changed_at|timesince }} ago by {{ pending_approval.changed_by.get_full_name }}
                </small>
            </div>
        </div>
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    </div>
    {% endif %}

    <!-- Conversion Flow Information for Non-Ops Users -->
    {% if lead.status == 'conversion_requested' and user.role not in 'ops_team_lead,ops_exec'|split %}
    <div class="alert ops-approval-pending">
        <div class="d-flex align-items-center">
            <i class="fas fa-clock fa-2x text-warning mr-3"></i>
            <div>
                <h5 class="mb-1"><i class="fas fa-info-circle"></i> Conversion Request Under Review</h5>
                <p class="mb-1">
                    Your conversion request is currently being reviewed by the operations team for business verification.
                </p>
                <small class="text-muted">
                    <strong>Requested:</strong> {{ lead.conversion_requested_at|date:"M d, Y H:i" }} 
                    {% if lead.conversion_requested_by %}
                    by {{ lead.conversion_requested_by.get_full_name }}
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Left Column: Lead Information -->
        <div class="col-lg-5">
            <!-- Lead Information Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle"></i> Lead Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-4 fw-bold">Lead ID:</div>
                        <div class="col-8">
                            <code>{{ lead.lead_id }}</code>
                            <button class="btn btn-sm btn-outline-secondary ml-1" onclick="copyToClipboard('{{ lead.lead_id }}')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-4 fw-bold">Status:</div>
                        <div class="col-8">
                            <span class="badge badge-{{ lead.status|lead_status_badge }}">
                                {{ lead.get_status_display }}
                            </span>
                            {% if lead.status == 'conversion_requested' %}
                                <small class="d-block text-muted mt-1">
                                    Requested: {{ lead.conversion_requested_at|date:"M d, Y H:i" }}
                                </small>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-4 fw-bold">Assigned To:</div>
                        <div class="col-8">
                            {{ lead.assigned_to.get_full_name }}
                            <small class="d-block text-muted">{{ lead.assigned_to.role|title }}</small>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-4 fw-bold">Source:</div>
                        <div class="col-8">
                            {{ lead.get_source_display }}
                            {% if lead.source_details %}
                                <small class="d-block text-muted">({{ lead.source_details }})</small>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-4 fw-bold">Probability:</div>
                        <div class="col-8">
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar 
                                    {% if lead.probability >= 75 %}bg-success
                                    {% elif lead.probability >= 50 %}bg-warning
                                    {% else %}bg-danger{% endif %}" 
                                     role="progressbar" 
                                     style="width: {{ lead.probability }}%;" 
                                     aria-valuenow="{{ lead.probability }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    {{ lead.probability }}%
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-4 fw-bold">Created:</div>
                        <div class="col-8">{{ lead.created_at|date:"d M Y H:i" }}</div>
                    </div>
                    {% if lead.converted %}
                    <div class="alert alert-success mt-3">
                        <h6><i class="fas fa-check-circle"></i> Converted to Client</h6>
                        <div class="row">
                            <div class="col-6">
                                <strong>Client ID:</strong><br>
                                <code>{{ lead.client_id }}</code>
                            </div>
                            <div class="col-6">
                                <strong>Converted On:</strong><br>
                                {{ lead.converted_at|date:"d M Y H:i" }}
                            </div>
                        </div>
                        {% if lead.final_assigned_rm %}
                        <div class="mt-2">
                            <strong>Final RM:</strong> {{ lead.final_assigned_rm.get_full_name }}
                        </div>
                        {% endif %}
                        {% if lead.converted_by %}
                        <div class="mt-1">
                            <strong>Converted By:</strong> {{ lead.converted_by.get_full_name }}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Contact Information Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-address-book"></i> Contact Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-4 fw-bold">Name:</div>
                        <div class="col-8">{{ lead.name }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-4 fw-bold">Email:</div>
                        <div class="col-8">
                            {% if lead.email %}
                                <a href="mailto:{{ lead.email }}">{{ lead.email }}</a>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-4 fw-bold">Mobile:</div>
                        <div class="col-8">
                            {% if lead.mobile %}
                                <a href="tel:{{ lead.mobile }}">{{ lead.mobile }}</a>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lead Stats Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar"></i> Lead Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 class="text-primary">{{ interactions|length }}</h4>
                            <small class="text-muted">Interactions</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-success">{{ product_discussions|length }}</h4>
                            <small class="text-muted">Product Discussions</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-info">{{ status_changes|length }}</h4>
                            <small class="text-muted">Status Changes</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conversion Flow Information -->
            {% if not lead.converted %}
            <div class="card conversion-flow-info mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0 text-primary">
                        <i class="fas fa-route"></i> Conversion Process Flow
                    </h6>
                </div>
                <div class="card-body">
                    <div class="small">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge badge-secondary mr-2">1</span>
                            <span class="{% if user.role in 'rm,rm_head,business_head,top_management'|split %}text-primary{% endif %}">
                                RM/Manager requests conversion
                            </span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge badge-secondary mr-2">2</span>
                            <span class="{% if user.role in 'ops_team_lead,ops_exec'|split %}text-primary{% endif %}">
                                Ops team verifies business details
                            </span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge badge-secondary mr-2">3</span>
                            <span>Ops approves & assigns to final RM</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge badge-success mr-2">4</span>
                            <span>Client record created</span>
                        </div>
                    </div>
                    
                    {% if lead.status == 'conversion_requested' %}
                    <div class="mt-3 p-2 bg-warning text-dark rounded">
                        <small>
                            <i class="fas fa-clock"></i> Currently at step 2: 
                            Waiting for ops team verification
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column: Actions and Details -->
        <div class="col-lg-7">
            <!-- Business Verification Section for Ops Team -->
            {% if user.role in 'ops_team_lead,ops_exec'|split and pending_approval %}
            <div class="card verification-section mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0 text-white">
                        <i class="fas fa-clipboard-check"></i> Business Verification Center
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Conversion Request Summary -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-white">
                                <div class="card-body p-3">
                                    <h6 class="text-primary"><i class="fas fa-info-circle"></i> Request Summary</h6>
                                    <ul class="list-unstyled mb-0">
                                        <li><strong>Requested by:</strong> {{ pending_approval.changed_by.get_full_name }}</li>
                                        <li><strong>Role:</strong> {{ pending_approval.changed_by.role|title }}</li>
                                        <li><strong>Date:</strong> {{ pending_approval.changed_at|date:"M d, Y H:i" }}</li>
                                        <li><strong>Priority:</strong> 
                                            {% if pending_approval.changed_at|timesince|slice:":1" == "0" %}
                                                <span class="badge badge-danger">High</span>
                                            {% else %}
                                                <span class="badge badge-warning">Medium</span>
                                            {% endif %}
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-white">
                                <div class="card-body p-3">
                                    <h6 class="text-success"><i class="fas fa-chart-line"></i> Lead Activity</h6>
                                    <ul class="list-unstyled mb-0">
                                        <li><strong>Total Interactions:</strong> {{ interactions|length }}</li>
                                        <li><strong>Product Discussions:</strong> {{ product_discussions|length }}</li>
                                        <li><strong>Time as Lead:</strong> {{ lead.created_at|timesince }}</li>
                                        <li><strong>Last Activity:</strong> 
                                            {% if interactions.0 %}
                                                {{ interactions.0.interaction_date|timesince }} ago
                                            {% else %}
                                                No interactions
                                            {% endif %}
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if pending_approval.notes %}
                    <div class="alert alert-info">
                        <h6><i class="fas fa-sticky-note"></i> Conversion Notes:</h6>
                        <p class="mb-0">{{ pending_approval.notes }}</p>
                    </div>
                    {% endif %}

                    <!-- Client ID Preview -->
                    <div class="client-preview-card p-3 mb-4">
                        <h6 class="text-primary mb-2">
                            <i class="fas fa-id-card"></i> Client ID Preview
                        </h6>
                        <div class="input-group">
                            <input type="text" id="preview_client_id" class="form-control" 
                                   value="{{ auto_client_id }}" readonly>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-outline-secondary" onclick="regeneratePreviewClientId()">
                                    <i class="fas fa-sync-alt"></i> Regenerate
                                </button>
                            </div>
                        </div>
                        <small class="form-text text-muted">
                            This will be the client ID assigned upon approval.
                        </small>
                    </div>

                    <!-- Business Verification Form -->
                    <div class="card bg-white">
                        <div class="card-header">
                            <h6 class="text-primary mb-0">
                                <i class="fas fa-user-tie"></i> Business Verification & Assignment
                            </h6>
                        </div>
                        <div class="card-body">
                            <form id="business-verification-form" method="post" action="{% url 'approve_conversion' lead.pk %}">
                                {% csrf_token %}
                                <input type="hidden" name="approval_id" value="{{ pending_approval.id }}">
                                <input type="hidden" name="client_id" id="hidden_client_id" value="{{ auto_client_id }}">
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="assigned_rm_lead_detail" class="font-weight-bold">
                                                <i class="fas fa-user-tie"></i> Assign to RM: <span class="text-danger">*</span>
                                            </label>
                                            <select class="form-control" name="assigned_rm" id="assigned_rm_lead_detail" required>
                                                <option value="">-- Select Relationship Manager --</option>
                                                {% for rm in available_rms %}
                                                <option value="{{ rm.id }}" 
                                                    data-clients="{{ rm.clients.count|default:0 }}"
                                                    data-email="{{ rm.email }}"
                                                    {% if rm.id == lead.assigned_to.id %}selected{% endif %}>
                                                    {{ rm.get_full_name }} 
                                                    ({{ rm.clients.count|default:0 }} clients)
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <small class="form-text text-muted">
                                                Current lead RM can be changed based on business requirements.
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="business_verification_notes_lead_detail" class="font-weight-bold">
                                                <i class="fas fa-clipboard-list"></i> Verification Notes: <span class="text-danger">*</span>
                                            </label>
                                            <textarea class="form-control" name="business_verification_notes" 
                                                id="business_verification_notes_lead_detail" rows="4" 
                                                placeholder="Enter business verification details:&#10;• Client background verification&#10;• Credit/financial checks&#10;• Compliance verification&#10;• Risk assessment" required></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <button type="submit" class="btn btn-success btn-lg btn-block" onclick="return confirmApproval()">
                                            <i class="fas fa-check-circle"></i> Approve & Create Client
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-danger btn-lg btn-block" onclick="showRejectModal()">
                                            <i class="fas fa-times-circle"></i> Reject Conversion
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Quick Assignment Options -->
                    <div class="mt-3">
                        <h6 class="text-primary">
                            <i class="fas fa-bolt"></i> Quick Assignment Options
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-primary btn-sm btn-block" onclick="assignToSameRM()">
                                    <i class="fas fa-user-check"></i> Keep Current RM
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-info btn-sm btn-block" onclick="assignToLeastBusyRM()">
                                    <i class="fas fa-balance-scale"></i> Assign to Least Busy RM
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Status Management Card -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tasks"></i> Status Management
                    </h5>
                    <span class="badge badge-{{ lead.status|lead_status_badge }}">
                        {{ lead.get_status_display }}
                    </span>
                </div>
                <div class="card-body">
                    <!-- Status change form for non-ops users when not pending approval -->
                    {% if user.role not in 'ops_team_lead,ops_exec'|split or not pending_approval %}
                        {% if not lead.converted and lead.status != 'conversion_requested' %}
                        <form method="post" action="{% url 'change_lead_status' lead.pk %}" class="mb-3">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="new_status" class="form-label">Change Status</label>
                                        <select name="new_status" id="new_status" class="form-control" required>
                                            {% for value, label in lead.STATUS_CHOICES %}
                                                {% if value != lead.status and value != 'converted' and value != 'conversion_requested' %}
                                                <option value="{{ value }}">{{ label }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="notes" class="form-label">Notes</label>
                                        <textarea name="notes" id="notes" class="form-control" rows="2" required></textarea>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Update Status
                            </button>
                        </form>
                        {% endif %}
                    {% endif %}

                    <!-- Conversion request section - MANDATORY OPS VERIFICATION -->
                    {% if not lead.converted and user.role in 'rm,rm_head,business_head,top_management'|split and lead.status != 'conversion_requested' %}
                        {% if user.can_access_user_data|user_can_edit:lead or user == lead.assigned_to %}
                        <div class="conversion-request-section mt-4">
                            <div class="card border-success">
                                <div class="card-header bg-light">
                                    <h6 class="text-success mb-0">
                                        <i class="fas fa-paper-plane"></i> Ready for Conversion?
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info mb-3">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Conversion Process:</strong> All conversion requests must be verified by the operations team before creating a client record. This ensures compliance and quality standards.
                                    </div>
                                    
                                    <p class="text-muted small mb-3">
                                        <i class="fas fa-route"></i> 
                                        <strong>Process Flow:</strong> Request → Ops Verification → Business Approval → Client Creation
                                    </p>
                                    
                                    <form method="post" action="{% url 'request_conversion' lead.pk %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-success btn-lg" onclick="return confirmConversionRequest()">
                                            <i class="fas fa-paper-plane"></i> Request Conversion (Send to Ops)
                                        </button>
                                    </form>
                                    
                                    <small class="form-text text-muted mt-2">
                                        <i class="fas fa-clock"></i> 
                                        Your request will be sent to the operations team for business verification and approval.
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endif %}

                    <!-- Show current status if conversion requested -->
                    {% if lead.status == 'conversion_requested' and user.role not in 'ops_team_lead,ops_exec'|split %}
                    <div class="alert alert-warning">
                        <i class="fas fa-hourglass-half"></i>
                        <strong>Conversion Pending:</strong> Your conversion request is being reviewed by the operations team.
                        <br><small class="text-muted">
                            Requested on {{ lead.conversion_requested_at|date:"M d, Y H:i" }}
                            {% if lead.conversion_requested_by %}by {{ lead.conversion_requested_by.get_full_name }}{% endif %}
                        </small>
                    </div>
                    {% endif %}

                    <!-- Show converted status -->
                    {% if lead.converted %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <strong>Successfully Converted:</strong> This lead has been converted to client {{ lead.client_id }}.
                        <br><small class="text-muted">
                            Converted on {{ lead.converted_at|date:"M d, Y H:i" }} by {{ lead.converted_by.get_full_name }}
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Interactions Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-comments"></i> Interactions
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Interaction form for non-ops users -->
                    {% if user.role not in 'ops_team_lead,ops_exec'|split %}
                    <form method="post" action="{% url 'add_interaction' lead.pk %}" id="interactionForm">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="interaction_type" class="form-label">Interaction Type *</label>
                                    <select name="interaction_type" id="interaction_type" class="form-control" required>
                                        <option value="call">Phone Call</option>
                                        <option value="meeting">In-Person Meeting</option>
                                        <option value="email">Email</option>
                                        <option value="message">Message</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="interaction_date" class="form-label">Date & Time *</label>
                                    <input type="datetime-local" name="interaction_date" id="interaction_date" 
                                           class="form-control" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="interaction_notes" class="form-label">Notes *</label>
                            <textarea name="notes" id="interaction_notes" class="form-control" rows="3" required></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="next_date" class="form-label">Next Follow-up Date</label>
                                    <input type="date" name="next_date" id="next_date" class="form-control">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="next_time" class="form-label">Next Follow-up Time</label>
                                    <input type="time" name="next_time" id="next_time" class="form-control">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="next_step" class="form-label">Next Step</label>
                            <input type="text" name="next_step" id="next_step" class="form-control">
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Add Interaction
                        </button>
                    </form>

                    <hr class="my-4">
                    {% endif %}

                    <!-- Interaction History -->
                    <h6>Interaction History ({{ interactions|length }})</h6>
                    {% if interactions %}
                    <div class="list-group">
                        {% for interaction in interactions %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">
                                    <i class="fas fa-
                                        {% if interaction.interaction_type == 'call' %}phone
                                        {% elif interaction.interaction_type == 'meeting' %}handshake
                                        {% elif interaction.interaction_type == 'email' %}envelope
                                        {% elif interaction.interaction_type == 'message' %}comment
                                        {% else %}star{% endif %}"></i>
                                    {{ interaction.get_interaction_type_display }}
                                </h6>
                                <small>{{ interaction.interaction_date|date:"d M Y H:i" }}</small>
                            </div>
                            <p class="mb-1">{{ interaction.notes }}</p>
                            <small class="text-muted">
                                By: {{ interaction.interacted_by.get_full_name }}
                                {% if interaction.next_step %}
                                    | Next: {{ interaction.next_step }}
                                    {% if interaction.next_date %}({{ interaction.next_date|date:"d M Y" }}){% endif %}
                                {% endif %}
                            </small>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No interactions recorded yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Product Discussion Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-shopping-cart"></i> Product Discussions
            </h5>
        </div>
        <div class="card-body">
            {% if lead.first_interaction_date and user.role not in 'ops_team_lead,ops_exec'|split %}
            <form method="post" action="{% url 'add_product_discussion' lead.pk %}">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="product" class="form-label">Product</label>
                            <select name="product" id="product" class="form-control" required>
                                {% for value, label in product_choices %}
                                <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="interest_level" class="form-label">Interest Level (1-10)</label>
                            <input type="number" name="interest_level" id="interest_level" 
                                   class="form-control" min="1" max="10" required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="product_notes" class="form-label">Notes</label>
                            <input type="text" name="notes" id="product_notes" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary btn-block">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                    </div>
                </div>
            </form>

            <hr class="my-4">
            {% elif user.role not in 'ops_team_lead,ops_exec'|split %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                Product discussions can be added after the first interaction with the lead.
            </div>
            {% endif %}

            <!-- Product Discussion Table -->
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead class="thead-light">
                        <tr>
                            <th><i class="fas fa-box"></i> Product</th>
                            <th><i class="fas fa-star"></i> Interest Level</th>
                            <th><i class="fas fa-calendar"></i> Discussed On</th>
                            <th><i class="fas fa-user"></i> Discussed By</th>
                            <th><i class="fas fa-notes-medical"></i> Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for discussion in product_discussions %}
                        <tr>
                            <td>
                                <span class="badge badge-primary">{{ discussion.get_product_display }}</span>
                            </td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar 
                                        {% if discussion.interest_level >= 8 %}bg-success
                                        {% elif discussion.interest_level >= 6 %}bg-warning
                                        {% else %}bg-danger{% endif %}" 
                                         role="progressbar" 
                                         style="width: {{ discussion.interest_level|multiply:10 }}%;" 
                                         aria-valuenow="{{ discussion.interest_level }}" 
                                         aria-valuemin="1" 
                                         aria-valuemax="10">
                                        {{ discussion.interest_level }}/10
                                    </div>
                                </div>
                            </td>
                            <td>{{ discussion.discussed_on|date:"d M Y" }}</td>
                            <td>{{ discussion.discussed_by.get_full_name }}</td>
                            <td>{{ discussion.notes|default:"-" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                                <br>No product discussions recorded yet
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Status History Card -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-history"></i> Status History
            </h5>
        </div>
        <div class="card-body">
            <div class="timeline">
                {% for change in status_changes %}
                <div class="timeline-item {% if change.needs_approval and not change.approved %}timeline-item-pending{% endif %}">
                    <div class="timeline-item-marker">
                        <div class="timeline-item-marker-indicator bg-{{ change.new_status|lead_status_badge }}"></div>
                    </div>
                    <div class="timeline-item-content">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">
                                    {{ change.get_new_status_display }}
                                    {% if change.needs_approval and not change.approved %}
                                        <span class="badge badge-warning ml-2">Pending Approval</span>
                                    {% elif change.approved %}
                                        <span class="badge badge-success ml-2">Approved</span>
                                    {% elif change.approved == False %}
                                        <span class="badge badge-danger ml-2">Rejected</span>
                                    {% endif %}
                                </h6>
                                <p class="mb-1 text-muted">
                                    Changed by {{ change.changed_by.get_full_name }}
                                    {% if change.old_status %}
                                        from <span class="badge badge-secondary">{{ change.get_old_status_display }}</span>
                                    {% endif %}
                                    {% if change.approved_by and change.approved_by != change.changed_by %}
                                        <br><small>Approved by {{ change.approved_by.get_full_name }}</small>
                                    {% endif %}
                                </p>
                                {% if change.notes %}
                                <div class="alert alert-light py-2 px-3 mb-1">
                                    <small>{{ change.notes }}</small>
                                </div>
                                {% endif %}
                            </div>
                            <div class="text-right">
                                <small class="text-muted">{{ change.changed_at|date:"d M Y H:i" }}</small>
                                {% if change.approved_at %}
                                    <br><small class="text-success">Approved: {{ change.approved_at|date:"d M Y H:i" }}</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4">
                    <i class="fas fa-history fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No status changes recorded</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Rejection Modal for Lead Detail Page -->
{% if user.role in 'ops_team_lead,ops_exec'|split and pending_approval %}
<div class="modal fade" id="leadRejectModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-times-circle"></i> Reject Conversion Request
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="post" action="{% url 'reject_conversion' lead.pk %}">
                {% csrf_token %}
                <input type="hidden" name="approval_id" value="{{ pending_approval.id }}">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Rejection Notice:</strong> You are about to reject the conversion request for <strong>{{ lead.name }}</strong>.
                        This action will notify the requesting team member and revert the lead status.
                    </div>
                    
                    <div class="form-group">
                        <label for="lead_rejection_reason" class="font-weight-bold">
                            <i class="fas fa-comment-alt"></i> Rejection Reason (Required):
                        </label>
                        <textarea class="form-control" name="rejection_reason" id="lead_rejection_reason" rows="4" 
                            placeholder="Please provide detailed reason for rejection..." required></textarea>
                    </div>
                    
                    <!-- Quick rejection reasons -->
                    <div class="form-group">
                        <label class="font-weight-bold">Quick Reasons:</label><br>
                        <button type="button" class="btn btn-outline-secondary btn-sm mr-1 mb-1" 
                                onclick="setQuickReason('Incomplete documentation provided')">
                            Incomplete Documentation
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm mr-1 mb-1" 
                                onclick="setQuickReason('Business criteria not met')">
                            Business Criteria Not Met
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm mr-1 mb-1" 
                                onclick="setQuickReason('Compliance issues identified')">
                            Compliance Issues
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm mr-1 mb-1" 
                                onclick="setQuickReason('Additional verification required')">
                            Additional Verification Required
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm mr-1 mb-1" 
                                onclick="setQuickReason('Lead quality does not meet client standards')">
                            Quality Standards Not Met
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-arrow-left"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times"></i> Reject Conversion Request
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set current datetime as default
    const now = new Date();
    const timezoneOffset = now.getTimezoneOffset() * 60000;
    const localISOTime = (new Date(now - timezoneOffset)).toISOString().slice(0, 16);
    if (document.getElementById('interaction_date')) {
        document.getElementById('interaction_date').value = localISOTime;
    }
    
    // Handle form submission to combine date and time
    const form = document.getElementById('interactionForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const nextDate = document.getElementById('next_date').value;
            const nextTime = document.getElementById('next_time').value;
            
            if (nextDate && nextTime) {
                // Create a hidden field with combined datetime
                const hiddenField = document.createElement('input');
                hiddenField.type = 'hidden';
                hiddenField.name = 'next_datetime';
                hiddenField.value = `${nextDate}T${nextTime}`;
                form.appendChild(hiddenField);
            }
        });
    }
});

// Copy to clipboard function
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Show temporary success message
        const button = event.target;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.classList.add('btn-success');
        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('btn-success');
        }, 1500);
    });
}

// Generate new client ID for preview (ops team)
function regeneratePreviewClientId() {
    fetch("{% url 'generate_client_id' %}", {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.client_id) {
            document.getElementById('preview_client_id').value = data.client_id;
            document.getElementById('hidden_client_id').value = data.client_id;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Fallback: generate client ID on frontend
        const now = new Date();
        const datepart = now.getFullYear().toString() + 
                        (now.getMonth() + 1).toString().padStart(2, '0') + 
                        now.getDate().toString().padStart(2, '0');
        const randompart = Math.floor(1000 + Math.random() * 9000).toString();
        const newClientId = `CL${datepart}${randompart}`;
        document.getElementById('preview_client_id').value = newClientId;
        document.getElementById('hidden_client_id').value = newClientId;
    });
}

// Confirmation for conversion request
function confirmConversionRequest() {
    return confirm(
        'Send Conversion Request?\n\n' +
        'This will send the lead to the operations team for business verification.\n\n' +
        'The ops team will:\n' +
        '• Verify business credentials\n' +
        '• Check compliance requirements\n' +
        '• Assign to appropriate RM\n' +
        '• Create client record upon approval\n\n' +
        'Continue with conversion request?'
    );
}

// Confirmation for approval
function confirmApproval() {
    const assignedRm = document.getElementById('assigned_rm_lead_detail').value;
    const notes = document.getElementById('business_verification_notes_lead_detail').value.trim();
    const clientId = document.getElementById('hidden_client_id').value;
    
    if (!assignedRm) {
        alert('Please select an RM to assign the client to.');
        return false;
    }
    
    if (!notes) {
        alert('Business verification notes are required for approval.');
        return false;
    }
    
    const selectedRM = document.getElementById('assigned_rm_lead_detail').selectedOptions[0].text;
    
    return confirm(`Confirm Conversion Approval:\n\n` +
                  `Lead: {{ lead.name }}\n` +
                  `Client ID: ${clientId}\n` +
                  `Assigned RM: ${selectedRM}\n\n` +
                  `This will create a new client record and notify the assigned RM.`);
}

// Show rejection modal
function showRejectModal() {
    $('#leadRejectModal').modal('show');
}

// Set quick rejection reason
function setQuickReason(reason) {
    const textarea = document.getElementById('lead_rejection_reason');
    if (textarea.value.trim() === '') {
        textarea.value = reason;
    } else {
        textarea.value += '\n' + reason;
    }
}

// Quick assignment functions
function assignToSameRM() {
    const currentRM = {{ lead.assigned_to.id }};
    document.getElementById('assigned_rm_lead_detail').value = currentRM;
}

function assignToLeastBusyRM() {
    const rmSelect = document.getElementById('assigned_rm_lead_detail');
    let leastBusyRM = null;
    let minClients = Infinity;
    
    Array.from(rmSelect.options).forEach(option => {
        if (option.value) {
            const clientCount = parseInt(option.getAttribute('data-clients') || '0');
            if (clientCount < minClients) {
                minClients = clientCount;
                leastBusyRM = option.value;
            }
        }
    });
    
    if (leastBusyRM) {
        rmSelect.value = leastBusyRM;
        // Show brief confirmation
        const selectedRM = rmSelect.selectedOptions[0].text;
        alert(`Selected: ${selectedRM} (${minClients} current clients)`);
    }
}

// Auto-refresh notification for ops team
{% if user.role in 'ops_team_lead,ops_exec'|split and pending_approval %}
// Check for new updates every 30 seconds
setInterval(() => {
    // Only check if no modals are open
    if (!document.querySelector('.modal.show')) {
        fetch(window.location.href, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            // Check if the pending approval status has changed
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const currentApproval = document.querySelector('.verification-section');
            const newApproval = doc.querySelector('.verification-section');
            
            if (!newApproval && currentApproval) {
                // Approval was processed, reload the page
                location.reload();
            }
        })
        .catch(error => {
            console.log('Auto-refresh check failed:', error);
        });
    }
}, 30000);
{% endif %}
</script>
{% endblock %}