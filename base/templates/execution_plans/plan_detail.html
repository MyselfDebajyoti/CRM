
{% extends 'execution_plans/base.html' %}

{% block title %}{{ execution_plan.plan_name }}{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'ongoing_plans' %}">Execution Plans</a></li>
        <li class="breadcrumb-item active">{{ execution_plan.plan_id }}</li>
    </ol>
</nav>
{% endblock %}

{% block extra_css %}
<style>
    .workflow-step {
        text-align: center;
        flex: 1;
        padding: 10px;
        position: relative;
    }
    
    .workflow-step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 50%;
        right: -15px;
        width: 30px;
        height: 2px;
        background-color: #dee2e6;
        z-index: 1;
    }
    
    .workflow-step.text-success:not(:last-child)::after {
        background-color: #28a745;
    }
    
    .action-row.completed {
        background-color: rgba(40, 167, 69, 0.1);
    }
    
    .action-row.failed {
        background-color: rgba(220, 53, 69, 0.1);
    }
    
    .action-row.pending {
        background-color: rgba(255, 193, 7, 0.1);
    }
    
    .progress-bar-animated {
        animation: progress-bar-stripes 1s linear infinite;
    }
    
    @keyframes progress-bar-stripes {
        0% { background-position: 1rem 0; }
        100% { background-position: 0 0; }
    }
    
    .analytics-chart {
        height: 300px;
    }
    
    .metric-card {
        transition: transform 0.2s ease-in-out;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
    }

    .email-status-indicator {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1050;
        max-width: 300px;
    }

    .notification-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
    }

    @media print {
        .btn, .modal, .card-header .dropdown, .workflow-step i {
            display: none !important;
        }
        
        .card {
            border: 1px solid #000 !important;
            box-shadow: none !important;
            page-break-inside: avoid;
        }
        
        .workflow-step {
            font-size: 12px;
        }
        
        .table {
            font-size: 12px;
        }
        
        @page {
            margin: 1in;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Plan Header with Enhanced Download Options -->
<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h1 class="h3">
            <i class="fas fa-file-alt text-primary me-2"></i>
            {{ execution_plan.plan_name }}
        </h1>
        <p class="text-muted mb-2">
            Plan ID: <strong>{{ execution_plan.plan_id }}</strong> | 
            Client: <strong>{{ execution_plan.client.name }}</strong>
            <!-- Email Status Badge -->
            {% if execution_plan.client.email or execution_plan.client.contact_info %}
                <span class="badge bg-success ms-2" id="emailStatusBadge">
                    <i class="fas fa-envelope me-1"></i>Email Available
                </span>
            {% else %}
                <span class="badge bg-warning ms-2" id="emailStatusBadge">
                    <i class="fas fa-exclamation-triangle me-1"></i>No Email
                </span>
            {% endif %}
        </p>
        <div class="d-flex align-items-center gap-3">
            {% if execution_plan.status == 'draft' %}
                <span class="badge bg-secondary fs-6">Draft</span>
            {% elif execution_plan.status == 'pending_approval' %}
                <span class="badge bg-warning fs-6">Pending Approval</span>
            {% elif execution_plan.status == 'approved' %}
                <span class="badge bg-success fs-6">Approved</span>
            {% elif execution_plan.status == 'client_approved' %}
                <span class="badge bg-info fs-6">Client Approved</span>
            {% elif execution_plan.status == 'in_execution' %}
                <span class="badge bg-primary fs-6">In Execution</span>
            {% elif execution_plan.status == 'completed' %}
                <span class="badge bg-success fs-6">Completed</span>
            {% elif execution_plan.status == 'rejected' %}
                <span class="badge bg-danger fs-6">Rejected</span>
            {% endif %}
            
            <small class="text-muted">
                Created: {{ execution_plan.created_at|date:"M d, Y" }} by {{ execution_plan.created_by.get_full_name|default:execution_plan.created_by.username }}
            </small>
        </div>
    </div>
    
    <!-- Enhanced Action Buttons with Download Options -->
    <div class="btn-group">
        <!-- Download Options Dropdown -->
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-download me-2"></i>Download
            </button>
            <ul class="dropdown-menu">
                <li>
                    <a class="dropdown-item" href="#" onclick="downloadExcel()">
                        <i class="fas fa-file-excel text-success me-2"></i>Excel File
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <a class="dropdown-item" href="#" onclick="generateFreshExcel()">
                        <i class="fas fa-sync-alt text-primary me-2"></i>Generate Fresh Excel
                    </a>
                </li>
            </ul>
        </div>
        
        <!-- Print Button -->
        <button type="button" class="btn btn-outline-secondary" onclick="printPlan()">
            <i class="fas fa-print me-2"></i>Print
        </button>
        
        {% if can_edit %}
        <a href="{% url 'create_plan_step2' execution_plan.client.id %}" class="btn btn-outline-secondary">
            <i class="fas fa-edit me-2"></i>Edit Plan
        </a>
        {% endif %}
        
        <!-- Email Plan Button -->
        {% if execution_plan.status in 'approved,client_approved,completed' %}
        <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#emailPlanModal">
            <i class="fas fa-envelope me-2"></i>Email Plan
        </button>
        {% endif %}
    </div>
</div>

{% if execution_plan.description %}
<div class="alert alert-light mb-4">
    <h6><i class="fas fa-info-circle me-2"></i>Description</h6>
    <p class="mb-0">{{ execution_plan.description }}</p>
</div>
{% endif %}

<!-- Download Status Card (appears when files are ready) -->
<div id="downloadStatusCard" class="alert alert-success alert-dismissible fade" role="alert" style="display: none;">
    <div class="d-flex align-items-center">
        <i class="fas fa-check-circle me-2 text-success"></i>
        <div class="flex-grow-1">
            <strong>Download Ready!</strong>
            <p class="mb-0" id="downloadMessage">Your file has been generated successfully.</p>
        </div>
        <div class="ms-3">
            <a href="#" id="downloadLink" class="btn btn-sm btn-success" download>
                <i class="fas fa-download me-1"></i>Download
            </a>
        </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>

<!-- Workflow Progress -->
<div class="card shadow-sm mb-4">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-route me-2"></i>Workflow Progress
        </h6>
    </div>
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <div class="workflow-step {% if execution_plan.status == 'draft' %}text-primary{% else %}text-success{% endif %}">
                <i class="fas fa-edit fa-2x mb-2"></i>
                <div>Draft</div>
                {% if execution_plan.created_at %}
                    <small>{{ execution_plan.created_at|date:"M d" }}</small>
                {% endif %}
            </div>
            
            <div class="workflow-step {% if execution_plan.status == 'pending_approval' %}text-primary{% elif execution_plan.submitted_at %}text-success{% else %}text-muted{% endif %}">
                <i class="fas fa-paper-plane fa-2x mb-2"></i>
                <div>Submitted</div>
                {% if execution_plan.submitted_at %}
                    <small>{{ execution_plan.submitted_at|date:"M d" }}</small>
                {% endif %}
            </div>
            
            <div class="workflow-step {% if execution_plan.status == 'approved' %}text-primary{% elif execution_plan.approved_at %}text-success{% else %}text-muted{% endif %}">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <div>Approved</div>
                {% if execution_plan.approved_at %}
                    <small>{{ execution_plan.approved_at|date:"M d" }}</small>
                {% endif %}
            </div>
            
            <div class="workflow-step {% if execution_plan.status == 'client_approved' %}text-primary{% elif execution_plan.client_approved_at %}text-success{% else %}text-muted{% endif %}">
                <i class="fas fa-user-check fa-2x mb-2"></i>
                <div>Client OK</div>
                {% if execution_plan.client_approved_at %}
                    <small>{{ execution_plan.client_approved_at|date:"M d" }}</small>
                {% endif %}
            </div>
            
            <div class="workflow-step {% if execution_plan.status == 'in_execution' %}text-primary{% elif execution_plan.execution_started_at %}text-success{% else %}text-muted{% endif %}">
                <i class="fas fa-cogs fa-2x mb-2"></i>
                <div>Execution</div>
                {% if execution_plan.execution_started_at %}
                    <small>{{ execution_plan.execution_started_at|date:"M d" }}</small>
                {% endif %}
            </div>
            
            <div class="workflow-step {% if execution_plan.status == 'completed' %}text-success{% else %}text-muted{% endif %}">
                <i class="fas fa-flag-checkered fa-2x mb-2"></i>
                <div>Complete</div>
                {% if execution_plan.completed_at %}
                    <small>{{ execution_plan.completed_at|date:"M d" }}</small>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons with Email Integration -->
{% if execution_plan.status != 'completed' and execution_plan.status != 'rejected' %}
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="d-flex flex-wrap gap-2">
            {% if execution_plan.status == 'draft' and execution_plan.created_by == user %}
                <button type="button" class="btn btn-primary" onclick="submitForApproval()">
                    <i class="fas fa-paper-plane me-2"></i>Submit for Approval
                </button>
            {% endif %}
            
            {% if execution_plan.status == 'pending_approval' and can_approve %}
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#approvalModal">
                    <i class="fas fa-check me-2"></i>Approve Plan
                </button>
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#rejectionModal">
                    <i class="fas fa-times me-2"></i>Reject Plan
                </button>
            {% endif %}
            
            {% if execution_plan.status == 'approved' and execution_plan.created_by == user %}
                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#sendClientModal">
                    <i class="fas fa-envelope me-2"></i>Send to Client
                </button>
                <button type="button" class="btn btn-success" onclick="markClientApproved()">
                    <i class="fas fa-user-check me-2"></i>Mark Client Approved
                </button>
            {% endif %}
            
            {% if execution_plan.status == 'client_approved' and can_execute %}
                <button type="button" class="btn btn-primary" onclick="startExecution()">
                    <i class="fas fa-play me-2"></i>Start Execution
                </button>
            {% endif %}

            {% if execution_plan.status == 'in_execution' and can_execute %}
                <button type="button" class="btn btn-success" onclick="markExecutionComplete()">
                    <i class="fas fa-flag-checkered me-2"></i>Mark Complete
                </button>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <!-- Plan Actions -->
    <div class="col-lg-8">
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>Plan Actions ({{ actions.count }})
                </h6>
            </div>
            <div class="card-body">
                {% if actions %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Action</th>
                                <th>Scheme</th>
                                <th>Amount/Units</th>
                                <th>Status</th>
                                {% if execution_plan.status == 'in_execution' and can_execute %}
                                <th>Actions</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for action in actions %}
                            <tr class="action-row {% if action.status == 'completed' %}completed{% elif action.status == 'failed' %}failed{% elif action.status == 'pending' %}pending{% endif %}" data-action-id="{{ action.id }}">
                                <td>{{ action.priority }}</td>
                                <td>
                                    <span class="badge bg-primary">{{ action.get_action_type_display }}</span>
                                    {% if action.sip_date %}
                                        <br><small class="text-muted">SIP Date: {{ action.sip_date }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div>{{ action.scheme.scheme_name }}</div>
                                    <small class="text-muted">{{ action.scheme.amc_name }}</small>
                                    {% if action.target_scheme %}
                                        <br><small class="text-info">→ {{ action.target_scheme.scheme_name }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if action.amount %}
                                        <div>₹{{ action.amount|floatformat:2 }}</div>
                                    {% endif %}
                                    {% if action.units %}
                                        <div>{{ action.units|floatformat:4 }} units</div>
                                    {% endif %}
                                    {% if action.executed_amount and action.executed_amount != action.amount %}
                                        <small class="text-success">Executed: ₹{{ action.executed_amount|floatformat:2 }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if action.status == 'pending' %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% elif action.status == 'in_progress' %}
                                        <span class="badge bg-info">In Progress</span>
                                    {% elif action.status == 'completed' %}
                                        <span class="badge bg-success">Completed</span>
                                        {% if action.executed_at %}
                                            <br><small>{{ action.executed_at|date:"M d, H:i" }}</small>
                                        {% endif %}
                                    {% elif action.status == 'failed' %}
                                        <span class="badge bg-danger">Failed</span>
                                        {% if action.failure_reason %}
                                            <br><small class="text-danger">{{ action.failure_reason|truncatechars:50 }}</small>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                {% if execution_plan.status == 'in_execution' and can_execute %}
                                <td>
                                    {% if action.status == 'pending' %}
                                        <button type="button" class="btn btn-sm btn-success execute-action-btn" 
                                                data-action-id="{{ action.id }}">
                                            <i class="fas fa-play"></i> Execute
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger mark-failed-btn" 
                                                data-action-id="{{ action.id }}">
                                            <i class="fas fa-times"></i> Failed
                                        </button>
                                    {% endif %}
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                    <h5>No Actions Found</h5>
                    <p>This execution plan has no actions defined.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Plan Summary & Comments -->
    <div class="col-lg-4">
        <!-- Plan Summary -->
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Plan Summary
                </h6>
            </div>
            <div class="card-body">
                {% if metrics %}
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <h6 class="text-muted">Total Investment</h6>
                        <div class="h5 text-success">₹{{ metrics.total_investment_amount|floatformat:0 }}</div>
                    </div>
                    <div class="col-6 mb-3">
                        <h6 class="text-muted">Total Redemption</h6>
                        <div class="h5 text-danger">₹{{ metrics.total_redemption_amount|floatformat:0 }}</div>
                    </div>
                    <div class="col-6 mb-3">
                        <h6 class="text-muted">Net Investment</h6>
                        <div class="h5 text-primary">₹{{ metrics.net_investment|floatformat:0 }}</div>
                    </div>
                    <div class="col-6 mb-3">
                        <h6 class="text-muted">Success Rate</h6>
                        <div class="h5 text-info">{{ metrics.success_rate|floatformat:1 }}%</div>
                    </div>
                </div>
                {% endif %}
                
                <div class="border-top pt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Actions:</span>
                        <strong>{{ actions.count }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Completed:</span>
                        <strong class="text-success">{{ actions|length }}</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Created By:</span>
                        <strong>{{ execution_plan.created_by.get_full_name|default:execution_plan.created_by.username }}</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Comments -->
        <div class="card shadow-sm">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-comments me-2"></i>Comments
                </h6>
            </div>
            <div class="card-body">
                <div id="commentsContainer" style="max-height: 300px; overflow-y: auto;">
                    {% for comment in comments %}
                    <div class="mb-3 pb-2 border-bottom">
                        <div class="d-flex justify-content-between align-items-start">
                            <strong>{{ comment.commented_by.get_full_name|default:comment.commented_by.username }}</strong>
                            <small class="text-muted">{{ comment.created_at|date:"M d, H:i" }}</small>
                        </div>
                        <p class="mb-1">{{ comment.comment }}</p>
                        {% if comment.is_internal %}
                            <span class="badge bg-warning">Internal</span>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="text-center text-muted">
                        <i class="fas fa-comment-slash fa-2x mb-2"></i>
                        <p>No comments yet</p>
                    </div>
                    {% endfor %}
                </div>
                
                <form id="commentForm" class="mt-3">
                    {% csrf_token %}
                    <div class="mb-2">
                        <textarea class="form-control" id="commentText" rows="2" 
                                  placeholder="Add a comment..." required></textarea>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isInternal">
                            <label class="form-check-label" for="isInternal">
                                Internal comment
                            </label>
                        </div>
                        <button type="submit" class="btn btn-sm btn-primary">
                            <i class="fas fa-paper-plane me-1"></i>Add
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Approval Modal with Email Options -->
<div class="modal fade" id="approvalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    Approve Execution Plan
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Plan Summary -->
                <div class="alert alert-info mb-4">
                    <h6><i class="fas fa-info-circle me-2"></i>Plan Summary</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Plan Name:</strong> {{ execution_plan.plan_name }}<br>
                            <strong>Client:</strong> {{ execution_plan.client.name }}<br>
                            <strong>Total Actions:</strong> {{ actions.count }}
                        </div>
                        <div class="col-md-6">
                            <strong>Created By:</strong> {{ execution_plan.created_by.get_full_name|default:execution_plan.created_by.username }}<br>
                            <strong>Submitted:</strong> {{ execution_plan.submitted_at|date:"M d, Y H:i"|default:"Not submitted" }}<br>
                            <strong>Plan ID:</strong> {{ execution_plan.plan_id }}
                        </div>
                    </div>
                </div>

                <!-- Approval Confirmation -->
                <div class="mb-4">
                    <p class="fw-bold">Are you sure you want to approve this execution plan?</p>
                    <p class="text-muted">
                        Once approved, the plan will be ready to send to the client for final approval.
                    </p>
                </div>

                <!-- Comments Section -->
                <div class="mb-4">
                    <label for="approvalComments" class="form-label">
                        <i class="fas fa-comment me-2"></i>Approval Comments
                    </label>
                    <textarea class="form-control" id="approvalComments" rows="3" 
                              placeholder="Add any comments or instructions for the client..."></textarea>
                    <div class="form-text">These comments will be included in the client email if sent.</div>
                </div>

                <!-- Email Options -->
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-envelope me-2"></i>Email Notification Options
                        </h6>
                    </div>
                    <div class="card-body">
                        <!-- Send Email Checkbox -->
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="sendEmailToClient" checked>
                            <label class="form-check-label fw-bold" for="sendEmailToClient">
                                Send approval notification to client
                            </label>
                        </div>

                        <!-- Client Email Detection -->
                        <div id="clientEmailInfo" class="mb-3">
                            {% if execution_plan.client.email or execution_plan.client.contact_info and '@' in execution_plan.client.contact_info %}
                                <div class="alert alert-success py-2">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Client Email:</strong> 
                                    {% if execution_plan.client.email %}
                                        {{ execution_plan.client.email }}
                                    {% elif execution_plan.client.contact_info and '@' in execution_plan.client.contact_info %}
                                        {{ execution_plan.client.contact_info }}
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="alert alert-warning py-2">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Warning:</strong> No email found for this client. You can still approve, but manual communication will be required.
                                </div>
                                <div class="mb-3">
                                    <label for="manualClientEmail" class="form-label">Client Email (Optional)</label>
                                    <input type="email" class="form-control" id="manualClientEmail" 
                                           placeholder="Enter client's email address">
                                    <div class="form-text">If provided, the approval email will be sent to this address.</div>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Additional Email Options -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeExcelAttachment" checked>
                                    <label class="form-check-label" for="includeExcelAttachment">
                                        Include Excel file
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="copyToRM" checked>
                                    <label class="form-check-label" for="copyToRM">
                                        Copy RM on email
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="rejectPlan()">Reject Plan</button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Send to Client Modal -->
<div class="modal fade" id="sendClientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-paper-plane text-primary me-2"></i>
                    Send Plan to Client
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Client Information -->
                <div class="alert alert-info mb-4">
                    <h6><i class="fas fa-user me-2"></i>Client Information</h6>
                    <div class="row">
                        <div class="col-md-8">
                            <strong>Name:</strong> {{ execution_plan.client.name }}<br>
                            <strong>Plan:</strong> {{ execution_plan.plan_name }}
                        </div>
                        <div class="col-md-4">
                            <strong>Status:</strong> 
                            <span class="badge bg-success">Approved</span>
                        </div>
                    </div>
                </div>

                <!-- Email Configuration -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <label for="clientEmailAddress" class="form-label">
                            <i class="fas fa-envelope me-2"></i>Client Email Address *
                        </label>
                        <input type="email" class="form-control" id="clientEmailAddress" 
                               value="{% if execution_plan.client.email %}{{ execution_plan.client.email }}{% elif '@' in execution_plan.client.contact_info|default:'' %}{{ execution_plan.client.contact_info }}{% endif %}" 
                               required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Send Copy To</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="copyToRM" checked>
                            <label class="form-check-label" for="copyToRM">
                                Copy to RM
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Email Subject -->
                <div class="mb-3">
                    <label for="emailSubject" class="form-label">Subject</label>
                    <input type="text" class="form-control" id="emailSubject" 
                           value="✅ Your Investment Plan is Ready for Review - {{ execution_plan.plan_name }}">
                </div>

                <!-- Message to Client -->
                <div class="mb-4">
                    <label for="clientEmailMessage" class="form-label">
                        <i class="fas fa-comment me-2"></i>Message to Client
                    </label>
                    <textarea class="form-control" id="clientEmailMessage" rows="6">Dear {{ execution_plan.client.name }},

I hope this email finds you well.

I'm pleased to inform you that your investment execution plan "{{ execution_plan.plan_name }}" has been approved and is ready for your review.

The plan includes {{ actions.count }} carefully selected action{{ actions.count|pluralize }} designed to optimize your investment portfolio based on our recent discussions and market analysis.

Please review the attached execution plan details. Once you're satisfied with the plan, please confirm your approval so we can proceed with the execution.

Key highlights of your plan:
- Plan ID: {{ execution_plan.plan_id }}
- Total Actions: {{ actions.count }}
- Expected Timeline: As discussed

If you have any questions or would like to discuss any aspect of the plan, please don't hesitate to reach out to me directly.

Thank you for your continued trust in our services.

Best regards,
{{ execution_plan.created_by.get_full_name|default:execution_plan.created_by.username }}
{{ execution_plan.created_by.email|default:"" }}</textarea>
                    <div class="form-text">This message will be sent to the client along with the execution plan details.</div>
                </div>

                <!-- Attachment Options -->
                <div class="card border-secondary">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-paperclip me-2"></i>Attachments
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeExcelFile" checked>
                                    <label class="form-check-label" for="includeExcelFile">
                                        <i class="fas fa-file-excel text-success me-2"></i>
                                        Include Excel File
                                    </label>
                                    <div class="form-text">Detailed execution plan with all actions</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="generateFreshExcel">
                                    <label class="form-check-label" for="generateFreshExcel">
                                        Generate fresh Excel file
                                    </label>
                                    <div class="form-text">Create updated file with latest data</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="sendToClientWithEmail()">
                    <i class="fas fa-paper-plane me-2"></i>Send to Client
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Email Plan Modal (General Purpose) -->
<div class="modal fade" id="emailPlanModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-envelope me-2"></i>Email Execution Plan
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="emailPlanForm">
                    <div class="mb-3">
                        <label for="emailTo" class="form-label">To Email Address *</label>
                        <input type="email" class="form-control" id="emailTo" 
                               value="{% if execution_plan.client.email %}{{ execution_plan.client.email }}{% elif '@' in execution_plan.client.contact_info|default:'' %}{{ execution_plan.client.contact_info }}{% endif %}" required>
                        <div class="form-text">Client's email will be used if available</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="emailCc" class="form-label">CC Email Address</label>
                        <input type="email" class="form-control" id="emailCc" 
                               placeholder="Additional email addresses (comma separated)">
                    </div>
                    
                    <div class="mb-3">
                        <label for="emailSubject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="emailSubject" 
                               value="Execution Plan - {{ execution_plan.plan_name }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="emailMessage" class="form-label">Message</label>
                        <textarea class="form-control" id="emailMessage" rows="4" 
                                  placeholder="Enter your message to the client...">Dear {{ execution_plan.client.name }},

Please find attached the execution plan for your investment portfolio.

Plan Details:
- Plan Name: {{ execution_plan.plan_name }}
- Plan ID: {{ execution_plan.plan_id }}
- Created Date: {{ execution_plan.created_at|date:"M d, Y" }}
- Total Actions: {{ actions.count }}

Please review the plan and let us know if you have any questions.

Best regards,
{{ execution_plan.created_by.get_full_name|default:execution_plan.created_by.username }}</textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="attachExcel" checked>
                                <label class="form-check-label" for="attachExcel">
                                    Attach Excel File
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendEmailPlan()">
                    <i class="fas fa-paper-plane me-2"></i>Send Email
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Download Progress Modal -->
<div class="modal fade" id="downloadProgressModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-download me-2"></i>Preparing Download
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p id="downloadStatus">Generating file...</p>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" id="downloadProgress"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Execute Action Modal -->
<div class="modal fade" id="executeActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Execute Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="executeActionContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmExecuteBtn">Execute Action</button>
            </div>
        </div>
    </div>
</div>

<!-- Mark Failed Modal -->
<div class="modal fade" id="markFailedModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mark Action as Failed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Please provide a reason for marking this action as failed:</p>
                <div class="mb-3">
                    <label for="failureReason" class="form-label">Failure Reason *</label>
                    <textarea class="form-control" id="failureReason" rows="3" 
                              placeholder="Enter failure reason..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmMarkFailedBtn">Mark as Failed</button>
            </div>
        </div>
    </div>
</div>

<!-- Email Status Indicator -->
<div id="emailStatusIndicator" class="email-status-indicator" style="display: none;">
    <div class="card shadow-sm border-0">
        <div class="card-body p-3">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm text-primary me-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div>
                    <div class="fw-bold">Sending Email...</div>
                    <small class="text-muted" id="emailStatusText">Preparing message</small>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let currentActionId = null;

// Enhanced JavaScript functions with email integration

// Submit for approval with email notifications
function submitForApproval() {
    if (confirm('Are you sure you want to submit this plan for approval? Approval managers will be notified automatically.')) {
        const submitUrl = `/execution-plans/{{ execution_plan.id }}/submit-with-email/`;
        
        // Show loading indicator
        const submitBtn = $('button[onclick="submitForApproval()"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Submitting...');
        
        $.post(submitUrl, {
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        }, function(response) {
            submitBtn.prop('disabled', false).html(originalText);
            
            if (response.success) {
                showNotification('Plan submitted for approval successfully! Approval managers have been notified.', 'success');
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showNotification('Error: ' + response.error, 'error');
            }
        }).fail(function(xhr) {
            submitBtn.prop('disabled', false).html(originalText);
            showNotification('Error submitting for approval. Please try again.', 'error');
        });
    }
}

// Enhanced approval function with email option
function approvePlanWithEmail() {
    const comments = $('#approvalComments').val();
    const sendEmail = $('#sendEmailToClient').is(':checked');
    const includeExcel = $('#includeExcelAttachment').is(':checked');
    const copyToRM = $('#copyToRM').is(':checked');
    const manualEmail = $('#manualClientEmail').val();
    
    // Show loading indicator
    showEmailStatus('Approving plan and preparing email...');
    
    const approveUrl = `/execution-plans/{{ execution_plan.id }}/approve-with-email/`;
    
    $.post(approveUrl, {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
        comments: comments,
        send_email: sendEmail,
        include_excel: includeExcel,
        copy_to_rm: copyToRM,
        manual_email: manualEmail
    }, function(response) {
        hideEmailStatus();
        
        if (response.success) {
            $('#approvalModal').modal('hide');
            
            let message = 'Plan approved successfully!';
            if (response.email_sent) {
                message += ` ✅ Email sent to client.`;
            } else if (sendEmail) {
                message += ` ⚠️ ${response.email_message}`;
            }
            
            showNotification(message, 'success');
            
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showNotification('Error: ' + response.error, 'error');
        }
    }).fail(function(xhr) {
        hideEmailStatus();
        showNotification('Error approving plan. Please try again.', 'error');
    });
}

// Enhanced client approval function with automatic email
function markClientApproved() {
    if (confirm('Are you sure the client has approved this execution plan? This will automatically notify the operations team.')) {
        const clientApproveUrl = `/execution-plans/{{ execution_plan.id }}/mark-client-approved-with-email/`;
        
        $.post(clientApproveUrl, {
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        }, function(response) {
            if (response.success) {
                showNotification(response.message, 'success');
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showNotification('Error: ' + response.error, 'error');
            }
        }).fail(function(xhr) {
            showNotification('Error marking client approved. Please try again.', 'error');
        });
    }
}

// Enhanced send to client function
function sendToClientWithEmail() {
    const emailTo = $('#clientEmailAddress').val();
    const subject = $('#emailSubject').val();
    const message = $('#clientEmailMessage').val();
    const includeExcel = $('#includeExcelFile').is(':checked');
    const generateFresh = $('#generateFreshExcel').is(':checked');
    const copyToRM = $('#copyToRM').is(':checked');
    
    if (!emailTo) {
        showNotification('Please enter a client email address', 'warning');
        return;
    }
    
    showEmailStatus('Sending plan to client...');
    
    const sendUrl = `/execution-plans/{{ execution_plan.id }}/send-to-client-enhanced/`;
    
    $.post(sendUrl, {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
        email_to: emailTo,
        subject: subject,
        message: message,
        include_excel: includeExcel,
        generate_fresh: generateFresh,
        copy_to_rm: copyToRM
    }, function(response) {
        hideEmailStatus();
        
        if (response.success) {
            $('#sendClientModal').modal('hide');
            showNotification('Plan sent to client successfully! ✅', 'success');
            
            // Update email status badge
            updateEmailStatusBadge('sent');
        } else {
            showNotification('Error: ' + response.error, 'error');
        }
    }).fail(function(xhr) {
        hideEmailStatus();
        showNotification('Error sending to client. Please try again.', 'error');
    });
}

// Enhanced execution completion function
function markExecutionComplete() {
    if (confirm('Are you sure all actions in this execution plan have been completed? This will automatically notify the client.')) {
        const completeUrl = `/execution-plans/{{ execution_plan.id }}/complete-with-email/`;
        
        // Show loading indicator
        showLoadingModal('Completing execution and preparing client notification...');
        
        $.post(completeUrl, {
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        }, function(response) {
            hideLoadingModal();
            
            if (response.success) {
                let message = response.message;
                if (response.email_sent) {
                    message += ` Client notification: ${response.email_message}`;
                }
                
                showNotification(message, 'success');
                setTimeout(() => {
                    location.reload();
                }, 3000);
            } else {
                showNotification('Error: ' + response.error, 'error');
            }
        }).fail(function(xhr) {
            hideLoadingModal();
            showNotification('Error completing execution. Please try again.', 'error');
        });
    }
}

// Reject plan
function rejectPlan() {
    const reason = $('#rejectionReason').val().trim();
    
    if (!reason) {
        showNotification('Please provide a rejection reason', 'warning');
        return;
    }
    
    const rejectUrl = `/execution-plans/{{ execution_plan.id }}/reject/`;
    
    $.post(rejectUrl, {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
        reason: reason
    }, function(response) {
        if (response.success) {
            $('#rejectionModal').modal('hide');
            showNotification('Plan rejected successfully', 'success');
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showNotification('Error: ' + response.error, 'error');
        }
    }).fail(function(xhr) {
        showNotification('Error rejecting plan. Please try again.', 'error');
    });
}

// Start execution
function startExecution() {
    if (confirm('Are you sure you want to start executing this plan?')) {
        const startExecutionUrl = `/execution-plans/{{ execution_plan.id }}/start-execution/`;
        
        $.post(startExecutionUrl, {
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        }, function(response) {
            if (response.success) {
                showNotification('Execution started successfully!', 'success');
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showNotification('Error: ' + response.error, 'error');
            }
        }).fail(function(xhr) {
            showNotification('Error starting execution. Please try again.', 'error');
        });
    }
}

// Email plan function (general purpose)
function sendEmailPlan() {
    const emailTo = $('#emailTo').val().trim();
    const emailCc = $('#emailCc').val().trim();
    const emailSubject = $('#emailSubject').val().trim();
    const emailMessage = $('#emailMessage').val().trim();
    const attachExcel = $('#attachExcel').is(':checked');
    
    if (!emailTo) {
        showNotification('Please enter a recipient email address', 'warning');
        return;
    }
    
    if (!emailSubject) {
        showNotification('Please enter an email subject', 'warning');
        return;
    }
    
    // Show loading state
    const sendBtn = $('#emailPlanModal .btn-primary');
    const originalText = sendBtn.html();
    sendBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Sending...');
    
    $.ajax({
        url: `/execution-plans/{{ execution_plan.id }}/email-plan/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
            'Content-Type': 'application/json'
        },
        data: JSON.stringify({
            email_to: emailTo,
            email_cc: emailCc,
            subject: emailSubject,
            message: emailMessage,
            attach_excel: attachExcel
        }),
        success: function(response) {
            sendBtn.prop('disabled', false).html(originalText);
            
            if (response.success) {
                $('#emailPlanModal').modal('hide');
                showNotification('Email sent successfully to ' + emailTo, 'success');
                
                // Reset form
                $('#emailPlanForm')[0].reset();
                $('#emailSubject').val('Execution Plan - {{ execution_plan.plan_name }}');
                $('#attachExcel').prop('checked', true);
            } else {
                showNotification('Error sending email: ' + response.error, 'error');
            }
        },
        error: function(xhr) {
            sendBtn.prop('disabled', false).html(originalText);
            console.error('Email sending error:', xhr);
            showNotification('Error sending email. Please try again.', 'error');
        }
    });
}

// Download Functions
function downloadExcel() {
    showDownloadProgress();
    updateDownloadProgress(20, 'Checking existing Excel file...');
    
    // Check if Excel file already exists
    const hasExcelFile = {{ execution_plan.excel_file|yesno:"true,false" }};
    
    if (hasExcelFile) {
        updateDownloadProgress(60, 'Excel file found, preparing download...');
        
        // Use existing Excel file
        const downloadUrl = `/execution-plans/{{ execution_plan.id }}/download-excel/`;
        downloadFile(downloadUrl, '{{ execution_plan.plan_id }}_execution_plan.xlsx');
        
        updateDownloadProgress(100, 'Download started!');
        setTimeout(() => {
            hideDownloadProgress();
            showDownloadSuccess('Excel file downloaded successfully!');
        }, 1000);
    } else {
        // Generate new Excel file
        generateFreshExcel();
    }
}

function generateFreshExcel() {
    showDownloadProgress();
    updateDownloadProgress(10, 'Generating new Excel file...');
    
    $.ajax({
        url: `/execution-plans/{{ execution_plan.id }}/generate-excel/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        xhr: function() {
            const xhr = new window.XMLHttpRequest();
            // Track upload progress
            xhr.upload.addEventListener("progress", function(evt) {
                if (evt.lengthComputable) {
                    const percentComplete = (evt.loaded / evt.total) * 100;
                    updateDownloadProgress(Math.min(percentComplete, 90), 'Generating Excel file...');
                }
            }, false);
            return xhr;
        },
        success: function(response) {
            if (response.success) {
                updateDownloadProgress(95, 'File generated, starting download...');
                
                // Download the generated file
                const downloadUrl = `/execution-plans/{{ execution_plan.id }}/download-excel/`;
                downloadFile(downloadUrl, response.filename || '{{ execution_plan.plan_id }}_execution_plan.xlsx');
                
                updateDownloadProgress(100, 'Download completed!');
                setTimeout(() => {
                    hideDownloadProgress();
                    showDownloadSuccess('Excel file generated and downloaded successfully!');
                }, 1000);
            } else {
                hideDownloadProgress();
                showNotification('Error generating Excel file: ' + response.error, 'error');
            }
        },
        error: function(xhr) {
            hideDownloadProgress();
            console.error('Excel generation error:', xhr);
            showNotification('Error generating Excel file. Please try again.', 'error');
        }
    });
}

// Print function
function printPlan() {
    // Hide non-printable elements
    $('.btn, .modal, .dropdown').hide();
    
    // Print
    window.print();
    
    // Restore hidden elements
    $('.btn, .modal, .dropdown').show();
}

// Utility functions for download progress
function showDownloadProgress() {
    $('#downloadProgressModal').modal('show');
    updateDownloadProgress(0, 'Starting...');
}

function hideDownloadProgress() {
    $('#downloadProgressModal').modal('hide');
    updateDownloadProgress(0, 'Starting...');
}

function updateDownloadProgress(percent, message) {
    $('#downloadProgress').css('width', percent + '%').attr('aria-valuenow', percent);
    $('#downloadStatus').text(message);
}

function showDownloadSuccess(message) {
    $('#downloadMessage').text(message);
    $('#downloadStatusCard').addClass('show').show();
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        $('#downloadStatusCard').removeClass('show').fadeOut();
    }, 5000);
}

// Generic file download function
function downloadFile(url, filename) {
    const link = document.createElement('a');
    link.href = url;
    link.download = filename || 'download';
    link.target = '_blank';
    
    // Append to body, click, and remove
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Update download link in success card
    $('#downloadLink').attr('href', url).attr('download', filename);
}

// Email status functions
function showEmailStatus(message) {
    $('#emailStatusText').text(message);
    $('#emailStatusIndicator').fadeIn();
}

function hideEmailStatus() {
    $('#emailStatusIndicator').fadeOut();
}

function updateEmailStatusBadge(status) {
    const badge = $('#emailStatusBadge');
    
    switch(status) {
        case 'sent':
            badge.removeClass().addClass('badge bg-success ms-2').html('<i class="fas fa-check me-1"></i>Email Sent');
            break;
        case 'pending':
            badge.removeClass().addClass('badge bg-warning ms-2').html('<i class="fas fa-clock me-1"></i>Email Pending');
            break;
        case 'failed':
            badge.removeClass().addClass('badge bg-danger ms-2').html('<i class="fas fa-times me-1"></i>Email Failed');
            break;
    }
}

// Loading modal functions
function showLoadingModal(message = 'Processing...') {
    const loadingHtml = `
        <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body text-center p-4">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p id="loadingMessage">${message}</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    $('body').append(loadingHtml);
    $('#loadingModal').modal('show');
}

function hideLoadingModal() {
    $('#loadingModal').modal('hide');
    setTimeout(() => {
        $('#loadingModal').remove();
    }, 500);
}

// Notification system
function showNotification(message, type = 'info') {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger', 
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';
    
    const icon = {
        'success': 'fa-check-circle',
        'error': 'fa-exclamation-circle',
        'warning': 'fa-exclamation-triangle', 
        'info': 'fa-info-circle'
    }[type] || 'fa-info-circle';
    
    const notificationHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
            <i class="fas ${icon} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('body').append(notificationHtml);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        $('.alert').fadeOut(500, function() {
            $(this).remove();
        });
    }, 5000);
}

// Loading modal functions
function showLoadingModal(message = 'Processing...') {
    const loadingHtml = `
        <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body text-center p-4">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p id="loadingMessage">${message}</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    $('body').append(loadingHtml);
    $('#loadingModal').modal('show');
}

function hideLoadingModal() {
    $('#loadingModal').modal('hide');
    setTimeout(() => {
        $('#loadingModal').remove();
    }, 500);
}

function updateLoadingMessage(message) {
    $('#loadingMessage').text(message);
}

// Auto-send e when plan status changes to specific states
$(document).ready(function() {
    // Monitor for status changes that should trigger emails
    const currentStatus = '{{ execution_plan.status }}';
    
    // Check if we should show email options based on status
    if (currentStatus === 'approved') {
        // Show option to send to client
        showEmailPrompt('approved');
    } else if (currentStatus === 'completed') {
        // Show completion summary
        showCompletionSummary();
    }
});

// Show email prompt for specific statuses
function showEmailPrompt(status) {
    const prompts = {
        'approved': {
            title: 'Plan Approved!',
            message: 'Would you like to send this approved plan to the client now?',
            action: 'sendToClient'
        },
        'completed': {
            title: 'Execution Complete!', 
            message: 'Would you like to send the execution summary to the client?',
            action: 'sendCompletionEmail'
        }
    };
    
    const prompt = prompts[status];
    if (!prompt) return;
    
    // Only show if email hasn't been sent recently
    const lastEmailSent = localStorage.getItem(`lastEmail_${execution_plan.id}_${status}`);
    const now = new Date().getTime();
    
    if (!lastEmailSent || (now - parseInt(lastEmailSent)) > 3600000) { // 1 hour
        setTimeout(() => {
            if (confirm(`${prompt.title}\n\n${prompt.message}`)) {
                if (prompt.action === 'sendToClient') {
                    $('#sendClientModal').modal('show');
                } else if (prompt.action === 'sendCompletionEmail') {
                    sendCompletionEmail();
                }
                
                // Remember that we showed this prompt
                localStorage.setItem(`lastEmail_${execution_plan.id}_${status}`, now.toString());
            }
        }, 1000);
    }
}

// Send completion email directly
function sendCompletionEmail() {
    const completeEmailUrl = `/execution-plans/{{ execution_plan.id }}/send-completion-email/`;
    
    showLoadingModal('Preparing completion email...');
    
    $.post(completeEmailUrl, {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
    }, function(response) {
        hideLoadingModal();
        
        if (response.success) {
            showNotification('Completion email sent to client successfully!', 'success');
        } else {
            showNotification('Error sending completion email: ' + response.error, 'error');
        }
    }).fail(function(xhr) {
        hideLoadingModal();
        showNotification('Error sending completion email. Please try again.', 'error');
    });
}

// Email preview function
function previewEmail(emailType) {
    const previewUrl = `/execution-plans/{{ execution_plan.id }}/preview-email/${emailType}/`;
    
    $.get(previewUrl, function(response) {
        if (response.success) {
            showEmailPreview(response.subject, response.html_content);
        } else {
            showNotification('Error loading email preview', 'error');
        }
    });
}

// Show email preview modal
function showEmailPreview(subject, htmlContent) {
    const previewHtml = `
        <div class="modal fade" id="emailPreviewModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Email Preview</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <strong>Subject:</strong> ${subject}
                        </div>
                        <div class="border p-3">
                            ${htmlContent}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="sendPreviewedEmail()">
                            <i class="fas fa-paper-plane me-2"></i>Send Email
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    $('body').append(previewHtml);
    $('#emailPreviewModal').modal('show');
    
    $('#emailPreviewModal').on('hidden.bs.modal', function() {
        $(this).remove();
    });
}

// Bulk email functions for multiple plans
function sendBulkEmails(planIds, emailType) {
    if (!planIds || planIds.length === 0) {
        showNotification('No plans selected', 'warning');
        return;
    }
    
    showLoadingModal(`Sending ${emailType} emails to ${planIds.length} clients...`);
    
    $.ajax({
        url: '/execution-plans/bulk-email/',
        method: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
            'Content-Type': 'application/json'
        },
        data: JSON.stringify({
            plan_ids: planIds,
            email_type: emailType
        }),
        success: function(response) {
            hideLoadingModal();
            
            if (response.success) {
                const successCount = response.results.filter(r => r.success).length;
                const failCount = response.results.length - successCount;
                
                let message = `Bulk email completed: ${successCount} sent successfully`;
                if (failCount > 0) {
                    message += `, ${failCount} failed`;
                }
                
                showNotification(message, successCount > 0 ? 'success' : 'warning');
            } else {
                showNotification('Error in bulk email: ' + response.error, 'error');
            }
        },
        error: function(xhr) {
            hideLoadingModal();
            showNotification('Error sending bulk emails. Please try again.', 'error');
        }
    });
}

function rejectPlan() {
    const reason = $('#rejectionReason').val().trim();
    
    if (!reason) {
        alert('Please provide a rejection reason');
        return;
    }
    
    const rejectUrl = `/execution-plans/{{ execution_plan.id }}/reject/`;
    
    $.post(rejectUrl, {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
        reason: reason
    }, function(response) {
        if (response.success) {
            location.reload();
        } else {
            alert('Error: ' + response.error);
        }
    }).fail(function(xhr) {
        alert('Error rejecting plan. Please try again.');
    });
}

function markClientApproved() {
    if (confirm('Are you sure the client has approved this execution plan?')) {
        const clientApproveUrl = `/execution-plans/{{ execution_plan.id }}/mark-client-approved/`;
        
        $.post(clientApproveUrl, {
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        }, function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert('Error: ' + response.error);
            }
        }).fail(function(xhr) {
            alert('Error marking client approved. Please try again.');
        });
    }
}

function startExecution() {
    if (confirm('Are you sure you want to start executing this plan?')) {
        const startExecutionUrl = `/execution-plans/{{ execution_plan.id }}/start-execution/`;
        
        $.post(startExecutionUrl, {
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        }, function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert('Error: ' + response.error);
            }
        }).fail(function(xhr) {
            alert('Error starting execution. Please try again.');
        });
    }
}

function sendToClient() {
    const message = $('#clientEmailMessage').val();
    const includeExcel = $('#includeExcelFile').is(':checked');
    const sendClientUrl = `/execution-plans/{{ execution_plan.id }}/send-to-client/`;
    
    $.post(sendClientUrl, {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
        message: message,
        include_excel: includeExcel
    }, function(response) {
        if (response.success) {
            $('#sendClientModal').modal('hide');
            alert('Plan sent to client successfully');
        } else {
            alert('Error: ' + response.error);
        }
    }).fail(function(xhr) {
        alert('Error sending to client. Please try again.');
    });
}

// Fixed comment form submission
$('#commentForm').on('submit', function(e) {
    e.preventDefault();
    
    const commentText = $('#commentText').val().trim();
    const isInternal = $('#isInternal').is(':checked');
    
    if (!commentText) {
        alert('Please enter a comment');
        return;
    }
    
    const addCommentUrl = `/execution-plans/{{ execution_plan.id }}/comments/add/`;
    
    $.post(addCommentUrl, {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
        comment: commentText,
        is_internal: isInternal
    }, function(response) {
        if (response.success) {
            // Add the new comment to the container
            const commentHtml = `
                <div class="mb-3 pb-2 border-bottom">
                    <div class="d-flex justify-content-between align-items-start">
                        <strong>${response.comment.user_name}</strong>
                        <small class="text-muted">${response.comment.created_at}</small>
                    </div>
                    <p class="mb-1">${response.comment.comment}</p>
                    ${response.comment.is_internal ? '<span class="badge bg-warning">Internal</span>' : ''}
                </div>
            `;
            
            if ($('#commentsContainer .text-center').length) {
                // Replace "no comments" message
                $('#commentsContainer').html(commentHtml);
            } else {
                // Prepend to existing comments
                $('#commentsContainer').prepend(commentHtml);
            }
            
            // Clear form
            $('#commentText').val('');
            $('#isInternal').prop('checked', false);
            
            // Scroll to top of comments
            $('#commentsContainer').scrollTop(0);
        } else {
            alert('Error adding comment: ' + response.error);
        }
    }).fail(function(xhr) {
        alert('Error adding comment. Please try again.');
    });
});

// Fixed analytics initialization
$('#analyticsModal').on('shown.bs.modal', function() {
    initializeAnalytics();
});

function initializeAnalytics() {
    // Status chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'Pending', 'Failed', 'In Progress'],
            datasets: [{
                data: [
                    {{ completed_actions_count|default:0 }},
                    {{ pending_actions_count|default:0 }},
                    {{ failed_actions_count|default:0 }},
                    {{ in_progress_actions_count|default:0 }}
                ],
                backgroundColor: [
                    '#28a745',
                    '#ffc107',
                    '#dc3545',
                    '#17a2b8'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Timeline chart
    const timelineCtx = document.getElementById('timelineChart').getContext('2d');
    const timelineUrl = `/execution-plans/{{ execution_plan.id }}/timeline-data/`;
    
    $.get(timelineUrl, function(response) {
        if (response.success) {
            new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: response.dates,
                    datasets: [{
                        label: 'Actions Executed',
                        data: response.counts,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    });
}

// Auto-refresh for execution status
{% if execution_plan.status == 'in_execution' %}
setInterval(function() {
    const statusUrl = `/execution-plans/{{ execution_plan.id }}/action-statuses/`;
    
    $.get(statusUrl, function(response) {
        if (response.success) {
            response.actions.forEach(function(action) {
                const row = $(`tr[data-action-id="${action.id}"]`);
                if (row.length) {
                    // Update status badge
                    const statusCell = row.find('td:nth-child(5)');
                    let statusHtml = '';
                    
                    switch(action.status) {
                        case 'completed':
                            statusHtml = '<span class="badge bg-success">Completed</span>';
                            if (action.executed_at) {
                                statusHtml += `<br><small>${action.executed_at}</small>`;
                            }
                            row.removeClass('pending failed').addClass('completed');
                            break;
                        case 'failed':
                            statusHtml = '<span class="badge bg-danger">Failed</span>';
                            if (action.failure_reason) {
                                statusHtml += `<br><small class="text-danger">${action.failure_reason}</small>`;
                            }
                            row.removeClass('pending completed').addClass('failed');
                            break;
                        case 'in_progress':
                            statusHtml = '<span class="badge bg-info">In Progress</span>';
                            break;
                        default:
                            statusHtml = '<span class="badge bg-warning">Pending</span>';
                    }
                    
                    statusCell.html(statusHtml);
                    
                    // Update action buttons if needed
                    if (action.status !== 'pending') {
                        row.find('.execute-action-btn, .mark-failed-btn').remove();
                    }
                }
            });
        }
    });
}, 30000); // Refresh every 30 seconds
{% endif %}

// Keyboard shortcuts
$(document).on('keydown', function(e) {
    // Ctrl+Enter to submit comment
    if (e.ctrlKey && e.which === 13 && $('#commentText').is(':focus')) {
        e.preventDefault();
        $('#commentForm').submit();
    }
    
    // Escape to close modals
    if (e.which === 27) {
        $('.modal').modal('hide');
    }
});

// Tooltip initialization
$(function () {
    $('[data-bs-toggle="tooltip"]').tooltip();
});

// Print functionality
function printPlan() {
    window.print();
}


// Workflow tracking
function trackWorkflowChange(fromStatus, toStatus, comments = '') {
    $.post('{% url "track_workflow" execution_plan.id %}', {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
        from_status: fromStatus,
        to_status: toStatus,
        comments: comments
    });
}

// Initialize page
$(document).ready(function() {
    // Add data attributes to action rows for JavaScript access
    $('tbody tr').each(function() {
        const actionId = $(this).find('.execute-action-btn, .mark-failed-btn').data('action-id');
        if (actionId) {
            $(this).attr('data-action-id', actionId);
        }
    });
    
    // Initialize progress bars if any
    $('.progress-bar').each(function() {
        const width = $(this).attr('aria-valuenow') + '%';
        $(this).css('width', width);
    });
    
    // Auto-focus comment textarea when clicking in comments area
    $('#commentsContainer').on('click', function() {
        $('#commentText').focus();
    });
    
    // Character counter for comments
    $('#commentText').on('input', function() {
        const maxLength = 500;
        const currentLength = $(this).val().length;
        const remaining = maxLength - currentLength;
        
        if (!$('#commentCounter').length) {
            $(this).after('<small id="commentCounter" class="text-muted"></small>');
        }
        
        $('#commentCounter').text(`${remaining} characters remaining`);
        
        if (remaining < 0) {
            $('#commentCounter').removeClass('text-muted').addClass('text-danger');
            $(this).addClass('is-invalid');
        } else {
            $('#commentCounter').removeClass('text-danger').addClass('text-muted');
            $(this).removeClass('is-invalid');
        }
    });
});

// Error handling for AJAX requests
$(document).ajaxError(function(event, xhr, settings, thrownError) {
    if (xhr.status === 403) {
        alert('Access denied. You may not have permission to perform this action.');
    } else if (xhr.status === 404) {
        alert('The requested resource was not found.');
    } else if (xhr.status >= 500) {
        alert('A server error occurred. Please try again or contact support.');
    }
});

// Confirmation dialogs for destructive actions
function confirmAction(message, callback) {
    if (confirm(message)) {
        callback();
    }
}

// Real-time notifications (if WebSocket is available)
{% if request.user.is_authenticated %}
// This would be implemented with WebSocket for real-time updates
function connectWebSocket() {
    // WebSocket implementation for real-time plan updates
    // This is a placeholder for future enhancement
}
{% endif %}
</script>

<!-- Print styles -->
<style media="print">
    .btn, .modal, .card-header .dropdown, .workflow-step i {
        display: none !important;
    }
    
    .card {
        border: 1px solid #000 !important;
        box-shadow: none !important;
        page-break-inside: avoid;
    }
    
    .workflow-step {
        font-size: 12px;
    }
    
    .table {
        font-size: 12px;
    }
    
    @page {
        margin: 1in;
    }
</style>
{% endblock %}