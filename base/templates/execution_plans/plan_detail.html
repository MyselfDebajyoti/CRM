{% extends 'execution_plans/base.html' %}

{% block title %}{{ execution_plan.plan_name }}{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'ongoing_plans' %}">Execution Plans</a></li>
        <li class="breadcrumb-item active">{{ execution_plan.plan_id }}</li>
    </ol>
</nav>
{% endblock %}

{% block extra_css %}
<style>
    .workflow-step {
        text-align: center;
        flex: 1;
        padding: 10px;
        position: relative;
    }
    
    .workflow-step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 50%;
        right: -15px;
        width: 30px;
        height: 2px;
        background-color: #dee2e6;
        z-index: 1;
    }
    
    .workflow-step.text-success:not(:last-child)::after {
        background-color: #28a745;
    }
    
    .action-row.completed {
        background-color: rgba(40, 167, 69, 0.1);
    }
    
    .action-row.failed {
        background-color: rgba(220, 53, 69, 0.1);
    }
    
    .action-row.pending {
        background-color: rgba(255, 193, 7, 0.1);
    }
    
    .progress-bar-animated {
        animation: progress-bar-stripes 1s linear infinite;
    }
    
    @keyframes progress-bar-stripes {
        0% { background-position: 1rem 0; }
        100% { background-position: 0 0; }
    }
    
    .analytics-chart {
        height: 300px;
    }
    
    .metric-card {
        transition: transform 0.2s ease-in-out;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<!-- Plan Header -->
<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h1 class="h3">
            <i class="fas fa-file-alt text-primary me-2"></i>
            {{ execution_plan.plan_name }}
        </h1>
        <p class="text-muted mb-2">
            Plan ID: <strong>{{ execution_plan.plan_id }}</strong> | 
            Client: <strong>{{ execution_plan.client.name }}</strong>
        </p>
        <div class="d-flex align-items-center gap-3">
            {% if execution_plan.status == 'draft' %}
                <span class="badge bg-secondary fs-6">Draft</span>
            {% elif execution_plan.status == 'pending_approval' %}
                <span class="badge bg-warning fs-6">Pending Approval</span>
            {% elif execution_plan.status == 'approved' %}
                <span class="badge bg-success fs-6">Approved</span>
            {% elif execution_plan.status == 'client_approved' %}
                <span class="badge bg-info fs-6">Client Approved</span>
            {% elif execution_plan.status == 'in_execution' %}
                <span class="badge bg-primary fs-6">In Execution</span>
            {% elif execution_plan.status == 'completed' %}
                <span class="badge bg-success fs-6">Completed</span>
            {% elif execution_plan.status == 'rejected' %}
                <span class="badge bg-danger fs-6">Rejected</span>
            {% endif %}
            
            <small class="text-muted">
                Created: {{ execution_plan.created_at|date:"M d, Y" }} by {{ execution_plan.created_by.get_full_name|default:execution_plan.created_by.username }}
            </small>
        </div>
    </div>
    
    <div class="btn-group">
        {% if can_edit %}
        <a href="{% url 'create_plan_step2' execution_plan.client.id %}" class="btn btn-outline-secondary">
            <i class="fas fa-edit me-2"></i>Edit Plan
        </a>
        {% endif %}
    </div>
</div>

{% if execution_plan.description %}
<div class="alert alert-light mb-4">
    <h6><i class="fas fa-info-circle me-2"></i>Description</h6>
    <p class="mb-0">{{ execution_plan.description }}</p>
</div>
{% endif %}

<!-- Workflow Progress -->
<div class="card shadow-sm mb-4">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-route me-2"></i>Workflow Progress
        </h6>
    </div>
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <div class="workflow-step {% if execution_plan.status == 'draft' %}text-primary{% else %}text-success{% endif %}">
                <i class="fas fa-edit fa-2x mb-2"></i>
                <div>Draft</div>
                {% if execution_plan.created_at %}
                    <small>{{ execution_plan.created_at|date:"M d" }}</small>
                {% endif %}
            </div>
            
            <div class="workflow-step {% if execution_plan.status == 'pending_approval' %}text-primary{% elif execution_plan.submitted_at %}text-success{% else %}text-muted{% endif %}">
                <i class="fas fa-paper-plane fa-2x mb-2"></i>
                <div>Submitted</div>
                {% if execution_plan.submitted_at %}
                    <small>{{ execution_plan.submitted_at|date:"M d" }}</small>
                {% endif %}
            </div>
            
            <div class="workflow-step {% if execution_plan.status == 'approved' %}text-primary{% elif execution_plan.approved_at %}text-success{% else %}text-muted{% endif %}">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <div>Approved</div>
                {% if execution_plan.approved_at %}
                    <small>{{ execution_plan.approved_at|date:"M d" }}</small>
                {% endif %}
            </div>
            
            <div class="workflow-step {% if execution_plan.status == 'client_approved' %}text-primary{% elif execution_plan.client_approved_at %}text-success{% else %}text-muted{% endif %}">
                <i class="fas fa-user-check fa-2x mb-2"></i>
                <div>Client OK</div>
                {% if execution_plan.client_approved_at %}
                    <small>{{ execution_plan.client_approved_at|date:"M d" }}</small>
                {% endif %}
            </div>
            
            <div class="workflow-step {% if execution_plan.status == 'in_execution' %}text-primary{% elif execution_plan.execution_started_at %}text-success{% else %}text-muted{% endif %}">
                <i class="fas fa-cogs fa-2x mb-2"></i>
                <div>Execution</div>
                {% if execution_plan.execution_started_at %}
                    <small>{{ execution_plan.execution_started_at|date:"M d" }}</small>
                {% endif %}
            </div>
            
            <div class="workflow-step {% if execution_plan.status == 'completed' %}text-success{% else %}text-muted{% endif %}">
                <i class="fas fa-flag-checkered fa-2x mb-2"></i>
                <div>Complete</div>
                {% if execution_plan.completed_at %}
                    <small>{{ execution_plan.completed_at|date:"M d" }}</small>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
{% if execution_plan.status != 'completed' and execution_plan.status != 'rejected' %}
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="d-flex flex-wrap gap-2">
            {% if execution_plan.status == 'draft' and execution_plan.created_by == user %}
                <button type="button" class="btn btn-primary" onclick="submitForApproval()">
                    <i class="fas fa-paper-plane me-2"></i>Submit for Approval
                </button>
            {% endif %}
            
            {% if execution_plan.status == 'pending_approval' and can_approve %}
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#approvalModal">
                    <i class="fas fa-check me-2"></i>Approve Plan
                </button>
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#rejectionModal">
                    <i class="fas fa-times me-2"></i>Reject Plan
                </button>
            {% endif %}
            
            {% if execution_plan.status == 'approved' and execution_plan.created_by == user %}
                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#sendClientModal">
                    <i class="fas fa-envelope me-2"></i>Send to Client
                </button>
                <button type="button" class="btn btn-success" onclick="markClientApproved()">
                    <i class="fas fa-user-check me-2"></i>Mark Client Approved
                </button>
            {% endif %}
            
            {% if execution_plan.status == 'client_approved' and can_execute %}
                <button type="button" class="btn btn-primary" onclick="startExecution()">
                    <i class="fas fa-play me-2"></i>Start Execution
                </button>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <!-- Plan Actions -->
    <div class="col-lg-8">
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>Plan Actions ({{ actions.count }})
                </h6>
            </div>
            <div class="card-body">
                {% if actions %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Action</th>
                                <th>Scheme</th>
                                <th>Amount/Units</th>
                                <th>Status</th>
                                {% if execution_plan.status == 'in_execution' and can_execute %}
                                <th>Actions</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for action in actions %}
                            <tr class="action-row {% if action.status == 'completed' %}completed{% elif action.status == 'failed' %}failed{% elif action.status == 'pending' %}pending{% endif %}">
                                <td>{{ action.priority }}</td>
                                <td>
                                    <span class="badge bg-primary">{{ action.get_action_type_display }}</span>
                                    {% if action.sip_date %}
                                        <br><small class="text-muted">SIP Date: {{ action.sip_date }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div>{{ action.scheme.scheme_name }}</div>
                                    <small class="text-muted">{{ action.scheme.amc_name }}</small>
                                    {% if action.target_scheme %}
                                        <br><small class="text-info">→ {{ action.target_scheme.scheme_name }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if action.amount %}
                                        <div>₹{{ action.amount|floatformat:2 }}</div>
                                    {% endif %}
                                    {% if action.units %}
                                        <div>{{ action.units|floatformat:4 }} units</div>
                                    {% endif %}
                                    {% if action.executed_amount and action.executed_amount != action.amount %}
                                        <small class="text-success">Executed: ₹{{ action.executed_amount|floatformat:2 }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if action.status == 'pending' %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% elif action.status == 'in_progress' %}
                                        <span class="badge bg-info">In Progress</span>
                                    {% elif action.status == 'completed' %}
                                        <span class="badge bg-success">Completed</span>
                                        {% if action.executed_at %}
                                            <br><small>{{ action.executed_at|date:"M d, H:i" }}</small>
                                        {% endif %}
                                    {% elif action.status == 'failed' %}
                                        <span class="badge bg-danger">Failed</span>
                                        {% if action.failure_reason %}
                                            <br><small class="text-danger">{{ action.failure_reason|truncatechars:50 }}</small>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                {% if execution_plan.status == 'in_execution' and can_execute %}
                                <td>
                                    {% if action.status == 'pending' %}
                                        <button type="button" class="btn btn-sm btn-success execute-action-btn" 
                                                data-action-id="{{ action.id }}">
                                            <i class="fas fa-play"></i> Execute
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger mark-failed-btn" 
                                                data-action-id="{{ action.id }}">
                                            <i class="fas fa-times"></i> Failed
                                        </button>
                                    {% endif %}
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                    <h5>No Actions Found</h5>
                    <p>This execution plan has no actions defined.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Plan Summary & Comments -->
    <div class="col-lg-4">
        <!-- Plan Summary -->
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Plan Summary
                </h6>
            </div>
            <div class="card-body">
                {% if metrics %}
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <h6 class="text-muted">Total Investment</h6>
                        <div class="h5 text-success">₹{{ metrics.total_investment_amount|floatformat:0 }}</div>
                    </div>
                    <div class="col-6 mb-3">
                        <h6 class="text-muted">Total Redemption</h6>
                        <div class="h5 text-danger">₹{{ metrics.total_redemption_amount|floatformat:0 }}</div>
                    </div>
                    <div class="col-6 mb-3">
                        <h6 class="text-muted">Net Investment</h6>
                        <div class="h5 text-primary">₹{{ metrics.net_investment|floatformat:0 }}</div>
                    </div>
                    <div class="col-6 mb-3">
                        <h6 class="text-muted">Success Rate</h6>
                        <div class="h5 text-info">{{ metrics.success_rate|floatformat:1 }}%</div>
                    </div>
                </div>
                {% endif %}
                
                <div class="border-top pt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Actions:</span>
                        <strong>{{ actions.count }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Completed:</span>
                        <strong class="text-success">{{ actions|length }}</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Created By:</span>
                        <strong>{{ execution_plan.created_by.get_full_name|default:execution_plan.created_by.username }}</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Comments -->
        <div class="card shadow-sm">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-comments me-2"></i>Comments
                </h6>
            </div>
            <div class="card-body">
                <div id="commentsContainer" style="max-height: 300px; overflow-y: auto;">
                    {% for comment in comments %}
                    <div class="mb-3 pb-2 border-bottom">
                        <div class="d-flex justify-content-between align-items-start">
                            <strong>{{ comment.commented_by.get_full_name|default:comment.commented_by.username }}</strong>
                            <small class="text-muted">{{ comment.created_at|date:"M d, H:i" }}</small>
                        </div>
                        <p class="mb-1">{{ comment.comment }}</p>
                        {% if comment.is_internal %}
                            <span class="badge bg-warning">Internal</span>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="text-center text-muted">
                        <i class="fas fa-comment-slash fa-2x mb-2"></i>
                        <p>No comments yet</p>
                    </div>
                    {% endfor %}
                </div>
                
                <form id="commentForm" class="mt-3">
                    {% csrf_token %}
                    <div class="mb-2">
                        <textarea class="form-control" id="commentText" rows="2" 
                                  placeholder="Add a comment..." required></textarea>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isInternal">
                            <label class="form-check-label" for="isInternal">
                                Internal comment
                            </label>
                        </div>
                        <button type="submit" class="btn btn-sm btn-primary">
                            <i class="fas fa-paper-plane me-1"></i>Add
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Approval Modal -->
<div class="modal fade" id="approvalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Approve Execution Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to approve this execution plan?</p>
                <div class="mb-3">
                    <label for="approvalComments" class="form-label">Comments (Optional)</label>
                    <textarea class="form-control" id="approvalComments" rows="3" 
                              placeholder="Add approval comments..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="approvePlan()">Approve Plan</button>
            </div>
        </div>
    </div>
</div>

<!-- Rejection Modal -->
<div class="modal fade" id="rejectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject Execution Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Please provide a reason for rejecting this execution plan:</p>
                <div class="mb-3">
                    <label for="rejectionReason" class="form-label">Rejection Reason *</label>
                    <textarea class="form-control" id="rejectionReason" rows="3" 
                              placeholder="Enter rejection reason..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="rejectPlan()">Reject Plan</button>
            </div>
        </div>
    </div>
</div>

<!-- Send to Client Modal -->
<div class="modal fade" id="sendClientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Plan to Client</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Send this execution plan to {{ execution_plan.client.name }} for approval?</p>
                <div class="mb-3">
                    <label for="clientEmailMessage" class="form-label">Message to Client (Optional)</label>
                    <textarea class="form-control" id="clientEmailMessage" rows="3" 
                              placeholder="Add a custom message for the client..."></textarea>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="includeExcelFile" checked>
                    <label class="form-check-label" for="includeExcelFile">
                        Include Excel file as attachment
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendToClient()">Send to Client</button>
            </div>
        </div>
    </div>
</div>

<!-- Analytics Modal -->
<div class="modal fade" id="analyticsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Plan Analytics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card metric-card text-center">
                            <div class="card-body">
                                <h5 class="text-success">{{ actions.count }}</h5>
                                <small class="text-muted">Total Actions</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card metric-card text-center">
                            <div class="card-body">
                                <h5 class="text-primary">{{ completed_actions_count|default:0 }}</h5>
                                <small class="text-muted">Completed</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card metric-card text-center">
                            <div class="card-body">
                                <h5 class="text-warning">{{ pending_actions_count|default:0 }}</h5>
                                <small class="text-muted">Pending</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card metric-card text-center">
                            <div class="card-body">
                                <h5 class="text-danger">{{ failed_actions_count|default:0 }}</h5>
                                <small class="text-muted">Failed</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Action Status Distribution</h6>
                        <canvas id="statusChart" class="analytics-chart"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h6>Execution Timeline</h6>
                        <canvas id="timelineChart" class="analytics-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Execute Action Modal -->
<div class="modal fade" id="executeActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Execute Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="executeActionContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmExecuteBtn">Execute Action</button>
            </div>
        </div>
    </div>
</div>

<!-- Mark Failed Modal -->
<div class="modal fade" id="markFailedModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mark Action as Failed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Please provide a reason for marking this action as failed:</p>
                <div class="mb-3">
                    <label for="failureReason" class="form-label">Failure Reason *</label>
                    <textarea class="form-control" id="failureReason" rows="3" 
                              placeholder="Enter failure reason..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmMarkFailedBtn">Mark as Failed</button>
            </div>
        </div>
    </div>
</div>
<!-- Enhanced Download Options Section -->
<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h1 class="h3">
            <i class="fas fa-file-alt text-primary me-2"></i>
            {{ execution_plan.plan_name }}
        </h1>
        <p class="text-muted mb-2">
            Plan ID: <strong>{{ execution_plan.plan_id }}</strong> | 
            Client: <strong>{{ execution_plan.client.name }}</strong>
        </p>
        <div class="d-flex align-items-center gap-3">
            {% if execution_plan.status == 'draft' %}
                <span class="badge bg-secondary fs-6">Draft</span>
            {% elif execution_plan.status == 'pending_approval' %}
                <span class="badge bg-warning fs-6">Pending Approval</span>
            {% elif execution_plan.status == 'approved' %}
                <span class="badge bg-success fs-6">Approved</span>
            {% elif execution_plan.status == 'client_approved' %}
                <span class="badge bg-info fs-6">Client Approved</span>
            {% elif execution_plan.status == 'in_execution' %}
                <span class="badge bg-primary fs-6">In Execution</span>
            {% elif execution_plan.status == 'completed' %}
                <span class="badge bg-success fs-6">Completed</span>
            {% elif execution_plan.status == 'rejected' %}
                <span class="badge bg-danger fs-6">Rejected</span>
            {% endif %}
            
            <small class="text-muted">
                Created: {{ execution_plan.created_at|date:"M d, Y" }} by {{ execution_plan.created_by.get_full_name|default:execution_plan.created_by.username }}
            </small>
        </div>
    </div>
    
    <!-- Enhanced Action Buttons with Download Options -->
    <div class="btn-group">
        <!-- Download Options Dropdown -->
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-download me-2"></i>Download
            </button>
            <ul class="dropdown-menu">
                <li>
                    <a class="dropdown-item" href="#" onclick="downloadExcel()">
                        <i class="fas fa-file-excel text-success me-2"></i>Excel File
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <a class="dropdown-item" href="#" onclick="generateFreshExcel()">
                        <i class="fas fa-sync-alt text-primary me-2"></i>Generate Fresh Excel
                    </a>
                </li>
            </ul>
        </div>
        
        <!-- Print Button -->
        <button type="button" class="btn btn-outline-secondary" onclick="printPlan()">
            <i class="fas fa-print me-2"></i>Print
        </button>
        
        {% if can_edit %}
        <a href="{% url 'create_plan_step2' execution_plan.client.id %}" class="btn btn-outline-secondary">
            <i class="fas fa-edit me-2"></i>Edit Plan
        </a>
        {% endif %}
        
        <!-- Email Plan Button -->
        {% if execution_plan.status in 'approved,client_approved,completed' %}
        <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#emailPlanModal">
            <i class="fas fa-envelope me-2"></i>Email Plan
        </button>
        {% endif %}
    </div>
</div>

<!-- Download Progress Modal -->
<div class="modal fade" id="downloadProgressModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-download me-2"></i>Preparing Download
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p id="downloadStatus">Generating file...</p>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" id="downloadProgress"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Email Plan Modal -->
<div class="modal fade" id="emailPlanModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-envelope me-2"></i>Email Execution Plan
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="emailPlanForm">
                    <div class="mb-3">
                        <label for="emailTo" class="form-label">To Email Address *</label>
                        <input type="email" class="form-control" id="emailTo" 
                               value="{{ execution_plan.client.email|default:'' }}" required>
                        <div class="form-text">Client's email will be used if available</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="emailCc" class="form-label">CC Email Address</label>
                        <input type="email" class="form-control" id="emailCc" 
                               placeholder="Additional email addresses (comma separated)">
                    </div>
                    
                    <div class="mb-3">
                        <label for="emailSubject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="emailSubject" 
                               value="Execution Plan - {{ execution_plan.plan_name }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="emailMessage" class="form-label">Message</label>
                        <textarea class="form-control" id="emailMessage" rows="4" 
                                  placeholder="Enter your message to the client...">Dear {{ execution_plan.client.name }},

Please find attached the execution plan for your investment portfolio.

Plan Details:
- Plan Name: {{ execution_plan.plan_name }}
- Plan ID: {{ execution_plan.plan_id }}
- Created Date: {{ execution_plan.created_at|date:"M d, Y" }}
- Total Actions: {{ actions.count }}

Please review the plan and let us know if you have any questions.

Best regards,
{{ execution_plan.created_by.get_full_name|default:execution_plan.created_by.username }}</textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="attachExcel" checked>
                                <label class="form-check-label" for="attachExcel">
                                    Attach Excel File
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="attachPDF">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendEmailPlan()">
                    <i class="fas fa-paper-plane me-2"></i>Send Email
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Download Status Card (appears when files are ready) -->
<div id="downloadStatusCard" class="alert alert-success alert-dismissible fade" role="alert" style="display: none;">
    <div class="d-flex align-items-center">
        <i class="fas fa-check-circle me-2 text-success"></i>
        <div class="flex-grow-1">
            <strong>Download Ready!</strong>
            <p class="mb-0" id="downloadMessage">Your file has been generated successfully.</p>
        </div>
        <div class="ms-3">
            <a href="#" id="downloadLink" class="btn btn-sm btn-success" download>
                <i class="fas fa-download me-1"></i>Download
            </a>
        </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let currentActionId = null;

// Submit for approval
function submitForApproval() {
    if (confirm('Are you sure you want to submit this plan for approval?')) {
        $.post('{% url "submit_for_approval" execution_plan.id %}', {
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        }, function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert('Error: ' + response.error);
            }
        });
    }
}
// Download Functions for Execution Plan

// Download Excel file
function downloadExcel() {
    showDownloadProgress();
    updateDownloadProgress(20, 'Checking existing Excel file...');
    
    // Check if Excel file already exists
    if ({{ execution_plan.excel_file|yesno:"true,false" }}) {
        updateDownloadProgress(60, 'Excel file found, preparing download...');
        
        // Use existing Excel file
        const downloadUrl = `/execution-plans/{{ execution_plan.id }}/download-excel/`;
        downloadFile(downloadUrl, '{{ execution_plan.plan_id }}_execution_plan.xlsx');
        
        updateDownloadProgress(100, 'Download started!');
        setTimeout(() => {
            hideDownloadProgress();
            showDownloadSuccess('Excel file downloaded successfully!');
        }, 1000);
    } else {
        // Generate new Excel file
        generateFreshExcel();
    }
}

// Generate fresh Excel file
function generateFreshExcel() {
    showDownloadProgress();
    updateDownloadProgress(10, 'Generating new Excel file...');
    
    $.ajax({
        url: `/execution-plans/{{ execution_plan.id }}/generate-excel/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        xhr: function() {
            const xhr = new window.XMLHttpRequest();
            // Track upload progress
            xhr.upload.addEventListener("progress", function(evt) {
                if (evt.lengthComputable) {
                    const percentComplete = (evt.loaded / evt.total) * 100;
                    updateDownloadProgress(Math.min(percentComplete, 90), 'Generating Excel file...');
                }
            }, false);
            return xhr;
        },
        success: function(response) {
            if (response.success) {
                updateDownloadProgress(95, 'File generated, starting download...');
                
                // Download the generated file
                const downloadUrl = `/execution-plans/{{ execution_plan.id }}/download-excel/`;
                downloadFile(downloadUrl, response.filename || '{{ execution_plan.plan_id }}_execution_plan.xlsx');
                
                updateDownloadProgress(100, 'Download completed!');
                setTimeout(() => {
                    hideDownloadProgress();
                    showDownloadSuccess('Excel file generated and downloaded successfully!');
                }, 1000);
            } else {
                hideDownloadProgress();
                alert('Error generating Excel file: ' + response.error);
            }
        },
        error: function(xhr) {
            hideDownloadProgress();
            console.error('Excel generation error:', xhr);
            alert('Error generating Excel file. Please try again.');
        }
    });
}

// Download PDF report
function downloadPDF() {
    showDownloadProgress();
    updateDownloadProgress(20, 'Generating PDF report...');
    
    $.ajax({
        url: `/execution-plans/{{ execution_plan.id }}/generate-pdf/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                updateDownloadProgress(80, 'PDF generated, starting download...');
                downloadFile(response.download_url, response.filename);
                updateDownloadProgress(100, 'Download completed!');
                setTimeout(() => {
                    hideDownloadProgress();
                    showDownloadSuccess('PDF report downloaded successfully!');
                }, 1000);
            } else {
                hideDownloadProgress();
                alert('Error generating PDF: ' + response.error);
            }
        },
        error: function(xhr) {
            hideDownloadProgress();
            alert('Error generating PDF. Please try again.');
        }
    });
}

// Download CSV data
function downloadCSV() {
    showDownloadProgress();
    updateDownloadProgress(30, 'Preparing CSV data...');
    
    const csvUrl = `/execution-plans/{{ execution_plan.id }}/export-csv/`;
    
    updateDownloadProgress(70, 'Generating CSV file...');
    downloadFile(csvUrl, '{{ execution_plan.plan_id }}_actions.csv');
    
    updateDownloadProgress(100, 'Download completed!');
    setTimeout(() => {
        hideDownloadProgress();
        showDownloadSuccess('CSV data downloaded successfully!');
    }, 1000);
}

// Email plan function
function sendEmailPlan() {
    const emailTo = $('#emailTo').val().trim();
    const emailCc = $('#emailCc').val().trim();
    const emailSubject = $('#emailSubject').val().trim();
    const emailMessage = $('#emailMessage').val().trim();
    const attachExcel = $('#attachExcel').is(':checked');
    const attachPDF = $('#attachPDF').is(':checked');
    
    if (!emailTo) {
        alert('Please enter a recipient email address');
        return;
    }
    
    if (!emailSubject) {
        alert('Please enter an email subject');
        return;
    }
    
    // Show loading state
    const sendBtn = $('#emailPlanModal .btn-primary');
    const originalText = sendBtn.html();
    sendBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Sending...');
    
    $.ajax({
        url: `/execution-plans/{{ execution_plan.id }}/email-plan/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
            'Content-Type': 'application/json'
        },
        data: JSON.stringify({
            email_to: emailTo,
            email_cc: emailCc,
            subject: emailSubject,
            message: emailMessage,
            attach_excel: attachExcel,
            attach_pdf: attachPDF
        }),
        success: function(response) {
            sendBtn.prop('disabled', false).html(originalText);
            
            if (response.success) {
                $('#emailPlanModal').modal('hide');
                showDownloadSuccess('Email sent successfully to ' + emailTo);
                
                // Reset form
                $('#emailPlanForm')[0].reset();
                $('#emailSubject').val('Execution Plan - {{ execution_plan.plan_name }}');
                $('#attachExcel').prop('checked', true);
            } else {
                alert('Error sending email: ' + response.error);
            }
        },
        error: function(xhr) {
            sendBtn.prop('disabled', false).html(originalText);
            console.error('Email sending error:', xhr);
            alert('Error sending email. Please try again.');
        }
    });
}

// Utility functions for download progress
function showDownloadProgress() {
    $('#downloadProgressModal').modal('show');
    updateDownloadProgress(0, 'Starting...');
}

function hideDownloadProgress() {
    $('#downloadProgressModal').modal('hide');
    updateDownloadProgress(0, 'Starting...');
}

function updateDownloadProgress(percent, message) {
    $('#downloadProgress').css('width', percent + '%').attr('aria-valuenow', percent);
    $('#downloadStatus').text(message);
}

function showDownloadSuccess(message) {
    $('#downloadMessage').text(message);
    $('#downloadStatusCard').addClass('show').show();
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        $('#downloadStatusCard').removeClass('show').fadeOut();
    }, 5000);
}

// Generic file download function
function downloadFile(url, filename) {
    const link = document.createElement('a');
    link.href = url;
    link.download = filename || 'download';
    link.target = '_blank';
    
    // Append to body, click, and remove
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Update download link in success card
    $('#downloadLink').attr('href', url).attr('download', filename);
}

// Print function
function printPlan() {
    // Hide non-printable elements
    $('.btn, .modal, .dropdown').hide();
    
    // Print
    window.print();
    
    // Restore hidden elements
    $('.btn, .modal, .dropdown').show();
}

// Bulk download function (for multiple plans)
function bulkDownloadPlans(planIds, format = 'excel') {
    if (!planIds || planIds.length === 0) {
        alert('No plans selected for download');
        return;
    }
    
    showDownloadProgress();
    updateDownloadProgress(10, `Preparing ${format} files for ${planIds.length} plans...`);
    
    $.ajax({
        url: '/execution-plans/bulk-download/',
        method: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
            'Content-Type': 'application/json'
        },
        data: JSON.stringify({
            plan_ids: planIds,
            format: format
        }),
        success: function(response) {
            if (response.success) {
                updateDownloadProgress(80, 'Files ready, starting download...');
                downloadFile(response.download_url, response.filename);
                updateDownloadProgress(100, 'Bulk download completed!');
                setTimeout(() => {
                    hideDownloadProgress();
                    showDownloadSuccess(`${planIds.length} plans downloaded as ${format.toUpperCase()}`);
                }, 1000);
            } else {
                hideDownloadProgress();
                alert('Error in bulk download: ' + response.error);
            }
        },
        error: function(xhr) {
            hideDownloadProgress();
            alert('Error in bulk download. Please try again.');
        }
    });
}

// Download with custom options
function downloadWithOptions() {
    const options = {
        include_client_details: $('#includeClientDetails').is(':checked'),
        include_portfolio: $('#includePortfolio').is(':checked'),
        include_comments: $('#includeComments').is(':checked'),
        include_workflow: $('#includeWorkflow').is(':checked'),
        format: $('#downloadFormat').val()
    };
    
    showDownloadProgress();
    updateDownloadProgress(20, 'Applying custom options...');
    
    $.ajax({
        url: `/execution-plans/{{ execution_plan.id }}/download-custom/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
            'Content-Type': 'application/json'
        },
        data: JSON.stringify(options),
        success: function(response) {
            if (response.success) {
                updateDownloadProgress(80, 'Custom file generated...');
                downloadFile(response.download_url, response.filename);
                updateDownloadProgress(100, 'Custom download completed!');
                setTimeout(() => {
                    hideDownloadProgress();
                    showDownloadSuccess('Custom file downloaded successfully!');
                }, 1000);
            } else {
                hideDownloadProgress();
                alert('Error generating custom file: ' + response.error);
            }
        },
        error: function(xhr) {
            hideDownloadProgress();
            alert('Error generating custom file. Please try again.');
        }
    });
}

// Initialize download tracking
$(document).ready(function() {
    // Track download events
    $(document).on('click', '[href*="download"]', function() {
        const downloadType = $(this).attr('href').includes('excel') ? 'excel' : 
                           $(this).attr('href').includes('pdf') ? 'pdf' : 'other';
        
        // Track download analytics
        gtag && gtag('event', 'download', {
            'event_category': 'execution_plan',
            'event_label': downloadType,
            'value': {{ execution_plan.id }}
        });
    });
    
    // Keyboard shortcuts for downloads
    $(document).on('keydown', function(e) {
        if (e.ctrlKey && e.altKey) {
            switch(e.which) {
                case 69: // Ctrl+Alt+E for Excel
                    e.preventDefault();
                    downloadExcel();
                    break;
                case 80: // Ctrl+Alt+P for PDF
                    e.preventDefault();
                    downloadPDF();
                    break;
                case 67: // Ctrl+Alt+C for CSV
                    e.preventDefault();
                    downloadCSV();
                    break;
            }
        }
    });
});

// Approve plan
function approvePlan() {
    const comments = $('#approvalComments').val();
    
    $.post('{% url "approve_plan" execution_plan.id %}', {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
        comments: comments
    }, function(response) {
        if (response.success) {
            location.reload();
        } else {
            alert('Error: ' + response.error);
        }
    });
}

// Reject plan
function rejectPlan() {
    const reason = $('#rejectionReason').val().trim();
    
    if (!reason) {
        alert('Please provide a rejection reason');
        return;
    }
    
    $.post('{% url "reject_plan" execution_plan.id %}', {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
        reason: reason
    }, function(response) {
        if (response.success) {
            location.reload();
        } else {
            alert('Error: ' + response.error);
        }
    });
}

// Mark client approved
function markClientApproved() {
    if (confirm('Are you sure the client has approved this execution plan?')) {
        $.post('{% url "mark_client_approved" execution_plan.id %}', {
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        }, function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert('Error: ' + response.error);
            }
        });
    }
}

// Start execution
function startExecution() {
    if (confirm('Are you sure you want to start executing this plan?')) {
        $.post('{% url "start_execution" execution_plan.id %}', {
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        }, function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert('Error: ' + response.error);
            }
        });
    }
}

// Send to client
function sendToClient() {
    const message = $('#clientEmailMessage').val();
    const includeExcel = $('#includeExcelFile').is(':checked');
    
    $.post('{% url "send_to_client" execution_plan.id %}', {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
        message: message,
        include_excel: includeExcel
    }, function(response) {
        if (response.success) {
            $('#sendClientModal').modal('hide');
            alert('Plan sent to client successfully');
        } else {
            alert('Error: ' + response.error);
        }
    });
}

// Add comment
$('#commentForm').on('submit', function(e) {
    e.preventDefault();
    
    const commentText = $('#commentText').val().trim();
    const isInternal = $('#isInternal').is(':checked');
    
    if (!commentText) {
        alert('Please enter a comment');
        return;
    }
    
    $.post('{% url "add_comment" execution_plan.id %}', {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
        comment: commentText,
        is_internal: isInternal
    }, function(response) {
        if (response.success) {
            // Add the new comment to the container
            const commentHtml = `
                <div class="mb-3 pb-2 border-bottom">
                    <div class="d-flex justify-content-between align-items-start">
                        <strong>${response.comment.user_name}</strong>
                        <small class="text-muted">${response.comment.created_at}</small>
                    </div>
                    <p class="mb-1">${response.comment.comment}</p>
                    ${response.comment.is_internal ? '<span class="badge bg-warning">Internal</span>' : ''}
                </div>
            `;
            
            if ($('#commentsContainer .text-center').length) {
                // Replace "no comments" message
                $('#commentsContainer').html(commentHtml);
            } else {
                // Prepend to existing comments
                $('#commentsContainer').prepend(commentHtml);
            }
            
            // Clear form
            $('#commentText').val('');
            $('#isInternal').prop('checked', false);
            
            // Scroll to top of comments
            $('#commentsContainer').scrollTop(0);
        } else {
            alert('Error adding comment: ' + response.error);
        }
    });
});

// Execute action handlers
$(document).on('click', '.execute-action-btn', function() {
    currentActionId = $(this).data('action-id');
    
    // Load action details - Fixed URL construction
    const actionDetailsUrl = `/execution-plans/actions/${currentActionId}/details/`;
    
    $.get(actionDetailsUrl, function(response) {
        if (response.success) {
            // Generate HTML content for the modal
            const action = response.action;
            const htmlContent = generateActionExecutionHTML(action);
            $('#executeActionContent').html(htmlContent);
            $('#executeActionModal').modal('show');
        } else {
            alert('Error loading action details: ' + response.error);
        }
    }).fail(function(xhr) {
        alert('Error loading action details. Please try again.');
        console.error('Action details error:', xhr);
    });
});

// Confirm execute action
$('#confirmExecuteBtn').on('click', function() {
    if (!currentActionId) return;
    
    const formData = $('#executeActionForm').serialize();
    const executeUrl = `/execution-plans/actions/${currentActionId}/execute/`;
    
    $.post(executeUrl, 
           formData + '&csrfmiddlewaretoken=' + $('[name=csrfmiddlewaretoken]').val(), 
           function(response) {
        if (response.success) {
            $('#executeActionModal').modal('hide');
            location.reload();
        } else {
            alert('Error executing action: ' + response.error);
        }
    }).fail(function(xhr) {
        alert('Error executing action. Please try again.');
        console.error('Execute action error:', xhr);
    });
});

// Mark failed handlers
$(document).on('click', '.mark-failed-btn', function() {
    currentActionId = $(this).data('action-id');
    $('#markFailedModal').modal('show');
});

// Confirm mark failed
$('#confirmMarkFailedBtn').on('click', function() {
    if (!currentActionId) return;
    
    const reason = $('#failureReason').val().trim();
    if (!reason) {
        alert('Please provide a failure reason');
        return;
    }
    
    const markFailedUrl = `/execution-plans/actions/${currentActionId}/mark-failed/`;
    
    $.post(markFailedUrl, {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
        failure_reason: reason
    }, function(response) {
        if (response.success) {
            $('#markFailedModal').modal('hide');
            $('#failureReason').val('');
            location.reload();
        } else {
            alert('Error marking action as failed: ' + response.error);
        }
    }).fail(function(xhr) {
        alert('Error marking action as failed. Please try again.');
        console.error('Mark failed error:', xhr);
    });
});

// Fixed workflow action URLs
function submitForApproval() {
    if (confirm('Are you sure you want to submit this plan for approval?')) {
        const submitUrl = `/execution-plans/{{ execution_plan.id }}/submit/`;
        
        $.post(submitUrl, {
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        }, function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert('Error: ' + response.error);
            }
        }).fail(function(xhr) {
            alert('Error submitting for approval. Please try again.');
        });
    }
}

function approvePlan() {
    const comments = $('#approvalComments').val();
    const approveUrl = `/execution-plans/{{ execution_plan.id }}/approve/`;
    
    $.post(approveUrl, {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
        comments: comments
    }, function(response) {
        if (response.success) {
            location.reload();
        } else {
            alert('Error: ' + response.error);
        }
    }).fail(function(xhr) {
        alert('Error approving plan. Please try again.');
    });
}

function rejectPlan() {
    const reason = $('#rejectionReason').val().trim();
    
    if (!reason) {
        alert('Please provide a rejection reason');
        return;
    }
    
    const rejectUrl = `/execution-plans/{{ execution_plan.id }}/reject/`;
    
    $.post(rejectUrl, {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
        reason: reason
    }, function(response) {
        if (response.success) {
            location.reload();
        } else {
            alert('Error: ' + response.error);
        }
    }).fail(function(xhr) {
        alert('Error rejecting plan. Please try again.');
    });
}

function markClientApproved() {
    if (confirm('Are you sure the client has approved this execution plan?')) {
        const clientApproveUrl = `/execution-plans/{{ execution_plan.id }}/mark-client-approved/`;
        
        $.post(clientApproveUrl, {
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        }, function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert('Error: ' + response.error);
            }
        }).fail(function(xhr) {
            alert('Error marking client approved. Please try again.');
        });
    }
}

function startExecution() {
    if (confirm('Are you sure you want to start executing this plan?')) {
        const startExecutionUrl = `/execution-plans/{{ execution_plan.id }}/start-execution/`;
        
        $.post(startExecutionUrl, {
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        }, function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert('Error: ' + response.error);
            }
        }).fail(function(xhr) {
            alert('Error starting execution. Please try again.');
        });
    }
}

function sendToClient() {
    const message = $('#clientEmailMessage').val();
    const includeExcel = $('#includeExcelFile').is(':checked');
    const sendClientUrl = `/execution-plans/{{ execution_plan.id }}/send-to-client/`;
    
    $.post(sendClientUrl, {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
        message: message,
        include_excel: includeExcel
    }, function(response) {
        if (response.success) {
            $('#sendClientModal').modal('hide');
            alert('Plan sent to client successfully');
        } else {
            alert('Error: ' + response.error);
        }
    }).fail(function(xhr) {
        alert('Error sending to client. Please try again.');
    });
}

// Fixed comment form submission
$('#commentForm').on('submit', function(e) {
    e.preventDefault();
    
    const commentText = $('#commentText').val().trim();
    const isInternal = $('#isInternal').is(':checked');
    
    if (!commentText) {
        alert('Please enter a comment');
        return;
    }
    
    const addCommentUrl = `/execution-plans/{{ execution_plan.id }}/comments/add/`;
    
    $.post(addCommentUrl, {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
        comment: commentText,
        is_internal: isInternal
    }, function(response) {
        if (response.success) {
            // Add the new comment to the container
            const commentHtml = `
                <div class="mb-3 pb-2 border-bottom">
                    <div class="d-flex justify-content-between align-items-start">
                        <strong>${response.comment.user_name}</strong>
                        <small class="text-muted">${response.comment.created_at}</small>
                    </div>
                    <p class="mb-1">${response.comment.comment}</p>
                    ${response.comment.is_internal ? '<span class="badge bg-warning">Internal</span>' : ''}
                </div>
            `;
            
            if ($('#commentsContainer .text-center').length) {
                // Replace "no comments" message
                $('#commentsContainer').html(commentHtml);
            } else {
                // Prepend to existing comments
                $('#commentsContainer').prepend(commentHtml);
            }
            
            // Clear form
            $('#commentText').val('');
            $('#isInternal').prop('checked', false);
            
            // Scroll to top of comments
            $('#commentsContainer').scrollTop(0);
        } else {
            alert('Error adding comment: ' + response.error);
        }
    }).fail(function(xhr) {
        alert('Error adding comment. Please try again.');
    });
});

// Fixed analytics initialization
$('#analyticsModal').on('shown.bs.modal', function() {
    initializeAnalytics();
});

function initializeAnalytics() {
    // Status chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'Pending', 'Failed', 'In Progress'],
            datasets: [{
                data: [
                    {{ completed_actions_count|default:0 }},
                    {{ pending_actions_count|default:0 }},
                    {{ failed_actions_count|default:0 }},
                    {{ in_progress_actions_count|default:0 }}
                ],
                backgroundColor: [
                    '#28a745',
                    '#ffc107',
                    '#dc3545',
                    '#17a2b8'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Timeline chart
    const timelineCtx = document.getElementById('timelineChart').getContext('2d');
    const timelineUrl = `/execution-plans/{{ execution_plan.id }}/timeline-data/`;
    
    $.get(timelineUrl, function(response) {
        if (response.success) {
            new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: response.dates,
                    datasets: [{
                        label: 'Actions Executed',
                        data: response.counts,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    });
}

// Auto-refresh for execution status
{% if execution_plan.status == 'in_execution' %}
setInterval(function() {
    const statusUrl = `/execution-plans/{{ execution_plan.id }}/action-statuses/`;
    
    $.get(statusUrl, function(response) {
        if (response.success) {
            response.actions.forEach(function(action) {
                const row = $(`tr[data-action-id="${action.id}"]`);
                if (row.length) {
                    // Update status badge
                    const statusCell = row.find('td:nth-child(5)');
                    let statusHtml = '';
                    
                    switch(action.status) {
                        case 'completed':
                            statusHtml = '<span class="badge bg-success">Completed</span>';
                            if (action.executed_at) {
                                statusHtml += `<br><small>${action.executed_at}</small>`;
                            }
                            row.removeClass('pending failed').addClass('completed');
                            break;
                        case 'failed':
                            statusHtml = '<span class="badge bg-danger">Failed</span>';
                            if (action.failure_reason) {
                                statusHtml += `<br><small class="text-danger">${action.failure_reason}</small>`;
                            }
                            row.removeClass('pending completed').addClass('failed');
                            break;
                        case 'in_progress':
                            statusHtml = '<span class="badge bg-info">In Progress</span>';
                            break;
                        default:
                            statusHtml = '<span class="badge bg-warning">Pending</span>';
                    }
                    
                    statusCell.html(statusHtml);
                    
                    // Update action buttons if needed
                    if (action.status !== 'pending') {
                        row.find('.execute-action-btn, .mark-failed-btn').remove();
                    }
                }
            });
        }
    });
}, 30000); // Refresh every 30 seconds
{% endif %}

// Keyboard shortcuts
$(document).on('keydown', function(e) {
    // Ctrl+Enter to submit comment
    if (e.ctrlKey && e.which === 13 && $('#commentText').is(':focus')) {
        e.preventDefault();
        $('#commentForm').submit();
    }
    
    // Escape to close modals
    if (e.which === 27) {
        $('.modal').modal('hide');
    }
});

// Tooltip initialization
$(function () {
    $('[data-bs-toggle="tooltip"]').tooltip();
});

// Print functionality
function printPlan() {
    window.print();
}


// Workflow tracking
function trackWorkflowChange(fromStatus, toStatus, comments = '') {
    $.post('{% url "track_workflow" execution_plan.id %}', {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
        from_status: fromStatus,
        to_status: toStatus,
        comments: comments
    });
}

// Initialize page
$(document).ready(function() {
    // Add data attributes to action rows for JavaScript access
    $('tbody tr').each(function() {
        const actionId = $(this).find('.execute-action-btn, .mark-failed-btn').data('action-id');
        if (actionId) {
            $(this).attr('data-action-id', actionId);
        }
    });
    
    // Initialize progress bars if any
    $('.progress-bar').each(function() {
        const width = $(this).attr('aria-valuenow') + '%';
        $(this).css('width', width);
    });
    
    // Auto-focus comment textarea when clicking in comments area
    $('#commentsContainer').on('click', function() {
        $('#commentText').focus();
    });
    
    // Character counter for comments
    $('#commentText').on('input', function() {
        const maxLength = 500;
        const currentLength = $(this).val().length;
        const remaining = maxLength - currentLength;
        
        if (!$('#commentCounter').length) {
            $(this).after('<small id="commentCounter" class="text-muted"></small>');
        }
        
        $('#commentCounter').text(`${remaining} characters remaining`);
        
        if (remaining < 0) {
            $('#commentCounter').removeClass('text-muted').addClass('text-danger');
            $(this).addClass('is-invalid');
        } else {
            $('#commentCounter').removeClass('text-danger').addClass('text-muted');
            $(this).removeClass('is-invalid');
        }
    });
});

// Error handling for AJAX requests
$(document).ajaxError(function(event, xhr, settings, thrownError) {
    if (xhr.status === 403) {
        alert('Access denied. You may not have permission to perform this action.');
    } else if (xhr.status === 404) {
        alert('The requested resource was not found.');
    } else if (xhr.status >= 500) {
        alert('A server error occurred. Please try again or contact support.');
    }
});

// Confirmation dialogs for destructive actions
function confirmAction(message, callback) {
    if (confirm(message)) {
        callback();
    }
}

// Real-time notifications (if WebSocket is available)
{% if request.user.is_authenticated %}
// This would be implemented with WebSocket for real-time updates
function connectWebSocket() {
    // WebSocket implementation for real-time plan updates
    // This is a placeholder for future enhancement
}
{% endif %}
</script>

<!-- Print styles -->
<style media="print">
    .btn, .modal, .card-header .dropdown, .workflow-step i {
        display: none !important;
    }
    
    .card {
        border: 1px solid #000 !important;
        box-shadow: none !important;
        page-break-inside: avoid;
    }
    
    .workflow-step {
        font-size: 12px;
    }
    
    .table {
        font-size: 12px;
    }
    
    @page {
        margin: 1in;
    }
</style>
{% endblock %}